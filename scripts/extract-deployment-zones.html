<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IA Deployment Zone Extractor</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; padding: 16px; background: #1e1e1e; color: #eee; }
    h1 { font-size: 1.2rem; margin-bottom: 8px; }
    .toolbar { margin-bottom: 12px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .toolbar label { display: flex; align-items: center; gap: 6px; }
    select { padding: 6px 10px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; }
    button { padding: 8px 16px; background: #0d6efd; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    button:hover { background: #0b5ed7; }
    button.export { background: #198754; }
    button.export:hover { background: #157347; }
    .legend { display: flex; gap: 16px; margin-bottom: 12px; font-size: 13px; }
    .legend span { display: flex; align-items: center; gap: 6px; }
    .legend .swatch { width: 20px; height: 20px; border-radius: 4px; }
    .swatch.red { background: rgba(220,53,69,0.6); }
    .swatch.blue { background: rgba(13,110,253,0.6); }
    .swatch.none { background: transparent; border: 2px solid #666; }
    .hint { font-size: 12px; color: #999; margin-bottom: 12px; }
    .container { position: relative; display: inline-block; max-width: 100%; overflow: auto; min-height: 200px; }
    #mapImg { display: block; max-width: 100%; height: auto; min-height: 100px; background: #333; }
    #overlay { position: absolute; left: 0; top: 0; cursor: crosshair; }
    #overlay.hidden { pointer-events: none; opacity: 0.5; }
    .output { margin-top: 16px; }
    textarea { width: 100%; min-height: 120px; padding: 12px; background: #2d2d2d; color: #0f0; font-family: monospace; font-size: 12px; border: 1px solid #444; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>IA Skirmish — Deployment Zone Extractor</h1>
  <p class="hint">Click each cell to cycle: none → Red zone → Blue zone → none. Match the zones on the map image. Export when done.</p>
  <div class="legend">
    <span><span class="swatch none"></span> Not in zone (click to set)</span>
    <span><span class="swatch red"></span> Red deployment zone</span>
    <span><span class="swatch blue"></span> Blue deployment zone</span>
  </div>
  <div class="toolbar">
    <label>Map: <select id="mapSelect"></select></label>
    <label>Or load image: <input type="file" id="imageInput" accept="image/*"></label>
    <button id="exportBtn" class="export">Export JSON</button>
    <button id="loadBtn">Load from JSON</button>
    <input type="file" id="fileInput" accept=".json" style="display:none">
  </div>
  <p id="statusMsg" class="hint" style="margin-bottom:8px">Load a map image to begin.</p>
  <div class="container">
    <img id="mapImg" alt="Map">
    <canvas id="overlay"></canvas>
  </div>
  <div class="output">
    <label>Exported data:</label>
    <textarea id="output" readonly placeholder="Click Export to generate JSON"></textarea>
  </div>

  <script>
    const MAPS = [
      { id: 'mos-eisley-outskirts', name: 'Mos Eisley Outskirts', image: '../vassal_extracted/images/Map_Mos Eisley Outskirts.gif', grid: { dx: 50, dy: 50, x0: 0, y0: 0 } },
    ];

    function colToLetter(col) {
      if (col < 26) return String.fromCharCode(65 + col);
      return colToLetter(Math.floor(col / 26) - 1) + colToLetter(col % 26);
    }

    function coordToKey(col, row) {
      return colToLetter(col).toLowerCase() + (row + 1);
    }

    let state = { red: [], blue: [] };
    let imgEl, overlay, ctx;
    let dx = 50, dy = 50, x0 = 0, y0 = 0;
    let numCols = 0, numRows = 0;
    let scale = 1;

    const mapSelect = document.getElementById('mapSelect');
    MAPS.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.id;
      opt.textContent = m.name;
      mapSelect.appendChild(opt);
    });

    function loadMap(map) {
      imgEl = document.getElementById('mapImg');
      overlay = document.getElementById('overlay');
      ctx = overlay.getContext('2d');
      dx = map.grid.dx;
      dy = map.grid.dy;
      x0 = map.grid.x0;
      y0 = map.grid.y0;

      if (map.image) {
        imgEl.src = map.image;
      }
      imgEl.onload = () => {
        const w = imgEl.naturalWidth;
        const h = imgEl.naturalHeight;
        const maxW = Math.min(w, 1400);
        scale = maxW / w;
        const sw = Math.round(w * scale);
        const sh = Math.round(h * scale);
        imgEl.style.width = sw + 'px';
        imgEl.style.height = sh + 'px';
        overlay.width = sw;
        overlay.height = sh;
        numCols = Math.floor((sw - x0 * scale) / (dx * scale));
        numRows = Math.floor((sh - y0 * scale) / (dy * scale));
        state = { red: [], blue: [] };
        draw();
      };
    }

    function draw() {
      if (!ctx || !overlay.width) return;
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      const sdx = dx * scale, sdy = dy * scale, sx0 = x0 * scale, sy0 = y0 * scale;
      for (let row = 0; row < numRows; row++) {
        for (let col = 0; col < numCols; col++) {
          const key = coordToKey(col, row);
          const x = sx0 + col * sdx;
          const y = sy0 + row * sdy;
          if (state.red.includes(key)) {
            ctx.fillStyle = 'rgba(220,53,69,0.45)';
            ctx.fillRect(x, y, sdx, sdy);
          } else if (state.blue.includes(key)) {
            ctx.fillStyle = 'rgba(13,110,253,0.45)';
            ctx.fillRect(x, y, sdx, sdy);
          }
          ctx.strokeStyle = 'rgba(255,255,255,0.15)';
          ctx.lineWidth = 1;
          ctx.strokeRect(x, y, sdx, sdy);
        }
      }
    }

    overlay.addEventListener('click', (e) => {
      const rect = overlay.getBoundingClientRect();
      const px = (e.clientX - rect.left) * (overlay.width / rect.width);
      const py = (e.clientY - rect.top) * (overlay.height / rect.height);
      const sx0 = x0 * scale, sy0 = y0 * scale, sdx = dx * scale, sdy = dy * scale;
      const col = Math.floor((px - sx0) / sdx);
      const row = Math.floor((py - sy0) / sdy);
      if (col < 0 || row < 0 || col >= numCols || row >= numRows) return;
      const key = coordToKey(col, row);
      if (state.red.includes(key)) {
        state.red = state.red.filter(k => k !== key);
        state.blue.push(key);
      } else if (state.blue.includes(key)) {
        state.blue = state.blue.filter(k => k !== key);
      } else {
        state.red.push(key);
      }
      state.red.sort();
      state.blue.sort();
      draw();
    });

    document.getElementById('exportBtn').onclick = () => {
      const mapId = mapSelect.value;
      const data = {
        source: 'Extracted via scripts/extract-deployment-zones.html',
        maps: { [mapId]: { red: state.red, blue: state.blue } }
      };
      const json = JSON.stringify(data, null, 2);
      document.getElementById('output').value = json;
      const blob = new Blob([json], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'deployment-zones.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    document.getElementById('loadBtn').onclick = () => document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const data = JSON.parse(r.result);
          const mapId = mapSelect.value;
          const mapData = data.maps?.[mapId] || data[mapId] || data;
          state.red = mapData.red || [];
          state.blue = mapData.blue || [];
          draw();
          document.getElementById('output').value = JSON.stringify(data, null, 2);
        } catch (err) {
          alert('Invalid JSON: ' + err.message);
        }
      };
      r.readAsText(f);
    };

    mapSelect.onchange = () => {
      const m = MAPS.find(x => x.id === mapSelect.value);
      if (m) loadMap(m);
    };

    document.getElementById('imageInput').onchange = (e) => {
      const f = e.target.files[0];
      if (!f) return;
      document.getElementById('statusMsg').textContent = 'Loading...';
      const reader = new FileReader();
      reader.onload = (ev) => {
        imgEl = document.getElementById('mapImg');
        overlay = document.getElementById('overlay');
        ctx = overlay.getContext('2d');
        dx = 50; dy = 50; x0 = 0; y0 = 0;
        const img = new Image();
        img.onload = () => {
          const w = img.naturalWidth || img.width;
          const h = img.naturalHeight || img.height;
          const maxW = Math.min(w, 1400);
          scale = maxW / w;
          const sw = Math.round(w * scale);
          const sh = Math.round(h * scale);
          imgEl.src = ev.target.result;
          imgEl.style.width = sw + 'px';
          imgEl.style.height = sh + 'px';
          imgEl.style.display = 'block';
          overlay.width = sw;
          overlay.height = sh;
          overlay.style.width = sw + 'px';
          overlay.style.height = sh + 'px';
          numCols = Math.floor((sw - x0 * scale) / (dx * scale));
          numRows = Math.floor((sh - y0 * scale) / (dy * scale));
          state = { red: [], blue: [] };
          draw();
          document.getElementById('statusMsg').textContent = 'Map loaded! Click cells to tag Red or Blue zones.';
        };
        img.onerror = () => { document.getElementById('statusMsg').textContent = 'Load failed.'; alert('Could not load image.'); };
        img.src = ev.target.result;
      };
      reader.onerror = () => { document.getElementById('statusMsg').textContent = 'Read failed.'; alert('Could not read file.'); };
      reader.readAsDataURL(f);
    };

    imgEl = document.getElementById('mapImg');
    overlay = document.getElementById('overlay');
    ctx = overlay.getContext('2d');
  </script>
</body>
</html>
