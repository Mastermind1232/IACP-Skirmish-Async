<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IA Skirmish â€” DC Effect Editor</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; padding: 20px; background: #1e1e1e; color: #eee; max-width: 1600px; zoom: 1.10; }
    h1 { font-size: 1.3rem; margin-bottom: 8px; }
    .hint { font-size: 12px; color: #999; margin-bottom: 16px; }
    .main { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    .card-img-wrap { flex-shrink: 0; width: 452px; background: #2d2d2d; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
    .card-img-wrap img { width: 100%; max-height: 667px; object-fit: contain; object-position: center; }
    .card-img-wrap .placeholder { color: #666; font-size: 13px; text-align: center; padding: 16px; }
    .form-wrap { flex: 1; min-width: 280px; display: flex; flex-direction: column; }
    .form-columns { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    .form-main { flex: 1; min-width: 280px; }
    .form-stats { flex: 0 0 400px; min-width: 340px; }
    label { display: block; margin-top: 12px; margin-bottom: 4px; font-weight: 500; }
    select, input, textarea { width: 100%; padding: 8px 12px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 14px; }
    textarea { min-height: 80px; font-family: inherit; resize: vertical; }
    textarea#abilityText { min-height: 160px; }
    .row { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    button { padding: 7px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
    button.primary { background: #0d6efd; color: #fff; }
    button.primary:hover { background: #0b5ed7; }
    button.export { background: #198754; color: #fff; }
    button.export:hover { background: #157347; }
    button.verified { background: #dc3545; color: #fff; }
    button.verified:hover { background: #bb2d3b; }
    .entries { margin-top: 24px; }
    .entries h2 { font-size: 1rem; margin-bottom: 8px; }
    .entry { padding: 8px 12px; margin-bottom: 6px; background: #2d2d2d; border-radius: 4px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
    .entry span { color: #aaa; }
    .entry button { padding: 4px 10px; font-size: 12px; background: #dc3545; }
    .entry button:hover { background: #bb2d3b; }
    .form-section { margin-top: 14px; padding-top: 12px; border-top: 1px solid #444; }
    .form-section-title { font-size: 12px; font-weight: 600; color: #aaa; margin-bottom: 8px; }
    /* Section grouping: distinct backgrounds and left borders for quick scanning */
    .form-block { padding: 14px 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid transparent; }
    .form-block-identity { background: rgba(60,60,80,0.35); border-left-color: #7c8; }
    .form-block-ability { background: rgba(50,60,70,0.4); border-left-color: #6ab; }
    .form-block-stats { background: rgba(70,55,50,0.35); border-left-color: #c85; }
    .form-block-figure { background: rgba(45,55,65,0.45); border-left-color: #5ac; }
    .form-block-flags { background: rgba(55,50,65,0.35); border-left-color: #a67; }
    textarea#abilityText.empty-or-tbd { background: rgba(160,120,50,0.15); border-color: #a85; }
    .ability-hint-empty { color: #b95; margin-top: 4px; }
    /* Chips: dice chips use the actual die color; surge/passives keep semantic tint */
    #attackDiceList .chip[data-value="red"] { background: #b33; color: #fff; border: 1px solid #822; }
    #attackDiceList .chip[data-value="blue"] { background: #36a; color: #fff; border: 1px solid #258; }
    #attackDiceList .chip[data-value="yellow"] { background: #d9a20e; color: #1a1a1a; border: 1px solid #a67a08; }
    #attackDiceList .chip[data-value="green"] { background: #2a7a2a; color: #fff; border: 1px solid #1a5a1a; }
    #attackDiceList .chip[data-value="special"] { background: #6a4a8a; color: #fff; border: 1px solid #4a2a6a; }
    #defenseList .chip[data-value="white"] { background: #e8e8e8; color: #222; border: 1px solid #aaa; }
    #defenseList .chip[data-value="black"] { background: #333; color: #eee; border: 1px solid #555; }
    #attackDiceList .chip[data-value="yellow"] button, #defenseList .chip[data-value="white"] button { color: #333; }
    #attackDiceList .chip[data-value="yellow"] button:hover, #defenseList .chip[data-value="white"] button:hover { color: #000; }
    #surgeList .chip { border-left: 3px solid #9a5; background: rgba(140,140,60,0.2); }
    #doubleSurgeList .chip { border-left: 3px solid #7a7; background: rgba(80,120,80,0.25); }
    #passivesList .chip { border-left: 3px solid #a67; background: rgba(140,90,120,0.2); }
    /* List: zebra striping and accent for unverified (needs review) */
    .entries .entry { border-left: 4px solid #e85; }
    .entries .entry:nth-child(odd) { background: #2d2d2d; }
    .entries .entry:nth-child(even) { background: #262626; }
    .entries h2 { padding: 8px 0; border-bottom: 1px solid #444; margin-bottom: 12px; }
    .form-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; margin-top: 8px; }
    .field { display: flex; flex-direction: column; gap: 2px; }
    .field.inline { flex: 0 0 auto; min-width: 72px; }
    .field.wide { flex: 1; min-width: 120px; }
    .field.grow { flex: 1; min-width: 160px; }
    .field label { margin-top: 0; font-size: 12px; }
    .field .hint { margin: 0; font-size: 11px; }
    .form-wrap .form-row input[type="number"], .form-wrap .form-row select { width: 100%; }
    .form-wrap .form-row .field.inline input { width: 100%; }
    .chip-list { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; min-height: 32px; padding: 4px 0; }
    .chip { display: inline-flex; align-items: center; gap: 4px; background: #444; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    .chip button { background: none; border: none; color: #999; cursor: pointer; padding: 0 2px; font-size: 16px; line-height: 1; }
    .chip button:hover { color: #fff; }
    .add-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .add-row select { width: auto; min-width: 120px; }
    #surgeSelect { min-width: 240px; }
    #passivesSelect { min-width: 220px; }
    .form-row-surge-passives { flex-direction: column; align-items: stretch; gap: 16px; }
    .form-row-surge-passives .field-surge { max-width: 100%; }
    .form-row-surge-passives .field-passives { max-width: 100%; margin-left: 0; }
    /* Compact right column to fit on screen without scrolling */
    .form-stats .form-block { padding: 10px 14px; margin-bottom: 8px; }
    .form-stats .form-section { margin-top: 6px; padding-top: 6px; }
    .form-stats .form-row { margin-top: 6px; }
    .form-stats label { margin-top: 6px; margin-bottom: 2px; }
    .form-stats .chip-list { min-height: 26px; padding: 2px 0; }
    .form-stats .form-section-title { margin-bottom: 4px; }
    .form-stats .form-row-surge-passives { gap: 10px; }
    button.secondary-btn { padding: 6px 12px; font-size: 12px; background: #444; color: #eee; border: 1px solid #555; border-radius: 4px; cursor: pointer; }
    button.secondary-btn:hover { background: #555; }
  </style>
</head>
<body>
  <h1>IA Skirmish â€” Deployment Card Effect Editor</h1>
  <p class="hint">Run <code>npm run cc-review</code> and open <code>http://localhost:3456/scripts/dc-effect-editor.html</code>. Shows <strong>Deployment Cards</strong> (figure DCs, Skirmish Upgrades) and <strong>Companion cards</strong>. Correct ability text and keywords, then click <strong>VERIFIED</strong>. Progress = unverified count shrinking to 0.</p>

  <div class="main">
    <div class="card-img-wrap" id="cardImgWrap">
      <div class="placeholder" id="cardImgPlaceholder">Select a card</div>
      <img id="cardImg" alt="" style="display:none">
      <div id="imgUpgradeBadge" style="display:none;width:100%;background:#0dcaf0;color:#000;font-weight:bold;text-align:center;padding:6px 0;font-size:13px;border-radius:0 0 6px 6px;letter-spacing:0.5px;">HIGH-RES IMAGE</div>
      <div style="margin-top:8px; width:100%;">
        <button type="button" id="pasteImageBtn" class="secondary-btn" style="width:100%;">Paste image from clipboard</button>
        <span class="hint" style="display:block; margin-top:4px; font-size:11px;">Select a card, copy an image (e.g. screenshot), then click the button or press <kbd>Ctrl+V</kbd> to save as this card&apos;s image.</span>
      </div>
    </div>
    <div class="form-wrap">
  <div class="form-columns">
    <div class="form-main">
  <div class="form-block form-block-identity">
  <label>Card name</label>
  <div class="form-row">
    <div class="field grow"><select id="cardSelect"><option value="">â€” Select or type below â€”</option></select></div>
    <div class="field grow"><input type="text" id="cardName" placeholder="Or type DC name manually"></div>
  </div>
  <label>Sub-name</label>
  <input type="text" id="subname" placeholder="e.g. Hero of the Rebellion, SPECTRE-1 (subtitle under card name)">
  <span class="hint" style="display:block; margin-top:2px;">Secondary title on the card; used for unique identification and some abilities (e.g. Spectre Allies).</span>
  </div>

  <div class="form-block form-block-ability">
  <label>Ability text</label>
  <textarea id="abilityText" placeholder="Paste or type the card's ability text (middle section only)"></textarea>
  <span class="hint ability-hint-empty" id="abilityHintEmpty" style="display:none;">Empty or TBD â€” needs attention</span>

  <label>Keywords</label>
  <input type="text" id="keywords" placeholder="e.g. Massive, Mobile (comma-separated)">
  </div>

  <div class="form-block form-block-stats">
  <div class="form-row">
    <div class="field inline">
      <label>Cost</label>
      <input type="number" id="cost" placeholder="pts" min="-10" max="40" step="1">
      <span class="hint">-10 to 40</span>
    </div>
    <div class="field inline">
      <label>Sub-cost</label>
      <input type="number" id="subCost" placeholder="VP per figure" min="0" max="20" step="1">
      <span class="hint">VP per figure when one is defeated (multifigure DCs)</span>
    </div>
    <div class="field inline">
      <label>Health</label>
      <input type="number" id="health" placeholder="â€”" min="1" max="99" step="1">
    </div>
    <div class="field inline">
      <label>Speed</label>
      <input type="number" id="speed" placeholder="â€”" min="1" max="8" step="1">
    </div>
    <div class="field inline">
      <label>Figures</label>
      <input type="number" id="figures" placeholder="â€”" min="0" max="4" step="1">
    </div>
  </div>
  </div>

    </div>
    <div class="form-stats">
  <div class="form-block form-block-figure">
  <div class="form-section">
    <div class="form-section-title">Figure stats (Squad Upgrades)</div>
    <div class="form-row">
      <div class="field inline" style="min-width: 120px;">
        <label>Attack type</label>
        <select id="attackType">
          <option value="">â€” Not set â€”</option>
          <option value="range">ðŸ”« Ranged</option>
          <option value="melee">âš” Melee</option>
        </select>
      </div>
      <div class="field wide">
        <label>Attack dice</label>
        <div class="add-row">
          <select id="attackDiceSelect">
            <option value="">Add dieâ€¦</option>
            <option value="red">Red</option>
            <option value="blue">Blue</option>
            <option value="yellow">Yellow</option>
            <option value="green">Green</option>
            <option value="special">Special</option>
          </select>
          <button type="button" id="attackDiceAdd" class="secondary-btn">Add</button>
        </div>
        <div id="attackDiceList" class="chip-list"></div>
      </div>
      <div class="field wide">
        <label>Defense die</label>
        <div class="add-row">
          <select id="defenseSelect">
            <option value="">Add dieâ€¦</option>
            <option value="white">White</option>
            <option value="black">Black</option>
          </select>
          <button type="button" id="defenseAdd" class="secondary-btn">Add</button>
        </div>
        <div id="defenseList" class="chip-list"></div>
      </div>
    </div>
    <div class="form-row form-row-surge-passives">
      <div class="field field-surge">
        <label>Surge abilities</label>
        <div class="add-row">
          <select id="surgeSelect">
            <option value="">Add surgeâ€¦</option>
            <optgroup label="â”€â”€ Hits â”€â”€">
              <option value="damage 1">+1 Hit</option>
              <option value="damage 2">+2 Hits</option>
              <option value="damage 1, accuracy 1">+1 Hit, +1 Accuracy</option>
              <option value="damage 1, accuracy 2">+1 Hit, +2 Accuracy</option>
              <option value="damage 1, cleave 1">+1 Hit, Cleave 1</option>
              <option value="damage 1, pierce 1">+1 Hit, Pierce 1</option>
              <option value="damage 1, weaken">+1 Hit, Weaken</option>
              <option value="damage 2, accuracy 1">+2 Hits, +1 Accuracy</option>
              <option value="damage 2, hide">+2 Hits, Hide</option>
            </optgroup>
            <optgroup label="â”€â”€ Accuracy â”€â”€">
              <option value="accuracy 1">+1 Accuracy</option>
              <option value="accuracy 2">+2 Accuracy</option>
              <option value="accuracy 3">+3 Accuracy</option>
              <option value="accuracy 1, damage 1">+1 Accuracy, +1 Hit</option>
              <option value="accuracy 1, pierce 1">+1 Accuracy, Pierce 1</option>
              <option value="accuracy 2, damage 1">+2 Accuracy, +1 Hit</option>
              <option value="accuracy 2, damage 2">+2 Accuracy, +2 Hits</option>
              <option value="accuracy 2, pierce 1">+2 Accuracy, Pierce 1</option>
              <option value="accuracy 2, weaken">+2 Accuracy, Weaken</option>
              <option value="accuracy 2, recover 1">+2 Accuracy, Recover 1</option>
              <option value="accuracy 3, pierce 1">+3 Accuracy, Pierce 1</option>
            </optgroup>
            <optgroup label="â”€â”€ Pierce / Blast / Cleave â”€â”€">
              <option value="pierce 1">Pierce 1</option>
              <option value="pierce 2">Pierce 2</option>
              <option value="pierce 3">Pierce 3</option>
              <option value="pierce 1, accuracy 2">Pierce 1, +2 Accuracy</option>
              <option value="pierce 1, hide">Pierce 1, Hide</option>
              <option value="pierce 1, weaken">Pierce 1, Weaken</option>
              <option value="blast 1">Blast 1</option>
              <option value="blast 2">Blast 2</option>
              <option value="blast 3 (2 surges)">Blast 3 (2 surges)</option>
              <option value="blast 1, cleave 1">Blast 1, Cleave 1</option>
              <option value="blast 1, recover 1">Blast 1 Recover 1</option>
              <option value="cleave 1">Cleave 1</option>
              <option value="cleave 2">Cleave 2</option>
              <option value="cancel 1">Cancel 1</option>
              <option value="cancel 2">Cancel 2</option>
            </optgroup>
            <optgroup label="â”€â”€ Conditions â”€â”€">
              <option value="bleed">Bleed</option>
              <option value="stun">Stun</option>
              <option value="weaken">Weaken</option>
              <option value="stun, pierce 1">Stun, Pierce 1</option>
              <option value="stun, evade token">Stun, Evade Token</option>
              <option value="weaken, focus">Weaken, Focus</option>
              <option value="hide">Hide</option>
            </optgroup>
            <optgroup label="â”€â”€ Tokens / Recover / Movement â”€â”€">
              <option value="focus">Focus</option>
              <option value="surge 1">+1 Surge</option>
              <option value="evade">Evade</option>
              <option value="hit token">Hit Token</option>
              <option value="hit token 2">2 Hit Tokens</option>
              <option value="block token">Block Token</option>
              <option value="Block 1">+1 Block</option>
              <option value="block 2">+2 Block</option>
              <option value="evade token">Evade Token</option>
              <option value="power token">Power Token</option>
              <option value="recover 1">Recover 1</option>
              <option value="recover 2">Recover 2</option>
              <option value="recover 3">Recover 3</option>
              <option value="recover 1 block token">Recover 1 Block Token</option>
              <option value="movement 2">+2 Movement</option>
            </optgroup>
          </select>
          <button type="button" id="surgeAdd" class="secondary-btn">Add</button>
        </div>
        <div id="surgeList" class="chip-list"></div>
      </div>
      <div class="field field-double-surge">
        <label>Double surge abilities (2 surges)</label>
        <div class="add-row">
          <select id="doubleSurgeSelect">
            <option value="">Add double surgeâ€¦</option>
            <optgroup label="â”€â”€ Hits â”€â”€">
              <option value="damage 1">+1 Hit</option>
              <option value="damage 2">+2 Hits</option>
              <option value="damage 1, accuracy 1">+1 Hit, +1 Accuracy</option>
              <option value="damage 1, accuracy 2">+1 Hit, +2 Accuracy</option>
              <option value="damage 2, accuracy 1">+2 Hits, +1 Accuracy</option>
              <option value="damage 2, hide">+2 Hits, Hide</option>
            </optgroup>
            <optgroup label="â”€â”€ Accuracy â”€â”€">
              <option value="accuracy 1">+1 Accuracy</option>
              <option value="accuracy 2">+2 Accuracy</option>
              <option value="accuracy 3">+3 Accuracy</option>
              <option value="accuracy 2, damage 1">+2 Accuracy, +1 Hit</option>
              <option value="accuracy 2, damage 2">+2 Accuracy, +2 Hits</option>
            </optgroup>
            <optgroup label="â”€â”€ Pierce / Blast / Cleave â”€â”€">
              <option value="pierce 1">Pierce 1</option>
              <option value="pierce 2">Pierce 2</option>
              <option value="pierce 3">Pierce 3</option>
              <option value="blast 1">Blast 1</option>
              <option value="blast 2">Blast 2</option>
              <option value="blast 3 (2 surges)">Blast 3 (2 surges)</option>
              <option value="cleave 1">Cleave 1</option>
              <option value="cleave 2">Cleave 2</option>
            </optgroup>
            <optgroup label="â”€â”€ Conditions â”€â”€">
              <option value="bleed">Bleed</option>
              <option value="stun">Stun</option>
              <option value="weaken">Weaken</option>
              <option value="hide">Hide</option>
            </optgroup>
            <optgroup label="â”€â”€ Tokens / Recover â”€â”€">
              <option value="focus">Focus</option>
              <option value="evade">Evade</option>
              <option value="block token">Block Token</option>
              <option value="power token">Power Token</option>
              <option value="Block 1">+1 Block</option>
              <option value="block 2">+2 Block</option>
              <option value="recover 1">Recover 1</option>
              <option value="recover 2">Recover 2</option>
              <option value="recover 3">Recover 3</option>
            </optgroup>
          </select>
          <button type="button" id="doubleSurgeAdd" class="secondary-btn">Add</button>
        </div>
        <div id="doubleSurgeList" class="chip-list"></div>
      </div>
      <div id="passivesField" class="field field-passives">
        <label>Passives</label>
        <div class="add-row">
          <select id="passivesSelect">
            <option value="">Add passiveâ€¦</option>
            <option value="Reach">Reach</option>
            <option value="Block 1">Block 1</option>
            <option value="Block 2">Block 2</option>
            <option value="+1 Evade">+1 Evade</option>
            <option value="+1 Hit">+1 Hit</option>
            <option value="+2 Hit">+2 Hit</option>
            <option value="Bleed">Bleed</option>
            <option value="Blast 1">Blast 1</option>
            <option value="Priority Target">Priority Target</option>
            <option value="Professional">Professional</option>
            <option value="+1 Accuracy">+1 Accuracy</option>
            <option value="+2 Accuracy">+2 Accuracy</option>
            <option value="+3 Accuracy">+3 Accuracy</option>
            <option value="+4 Accuracy">+4 Accuracy</option>
            <option value="Pierce 1">Pierce 1</option>
            <option value="Pierce 2">Pierce 2</option>
            <option value="Efficient Travel">Efficient Travel</option>
            <option value="Mobile">Mobile</option>
            <option value="Massive">Massive</option>
            <option value="Habitat: City">Habitat: City</option>
            <option value="Habitat: Desert">Habitat: Desert</option>
            <option value="Habitat: Forest">Habitat: Forest</option>
            <option value="Habitat: Snow">Habitat: Snow</option>
            <option value="__other__">Otherâ€¦</option>
          </select>
          <button type="button" id="passivesAdd" class="secondary-btn">Add</button>
        </div>
        <div id="passivesList" class="chip-list"></div>
      </div>
    </div>
  <div class="form-row" style="align-items: center; margin-top: 8px; padding-top: 6px; border-top: 1px solid #444;">
      <label style="display: flex; align-items: center; gap: 6px; margin: 0; font-size: 12px;">
        <input type="checkbox" id="attachment" style="width: auto;">
        <span>Attachment</span>
      </label>
      <label style="display: flex; align-items: center; gap: 6px; margin: 0; font-size: 12px;">
        <input type="checkbox" id="companion" style="width: auto;">
        <span>Companion</span>
      </label>
      <label style="display: flex; align-items: center; gap: 6px; margin: 0; font-size: 12px;">
        <input type="checkbox" id="elite" style="width: auto;">
        <span>Elite</span>
      </label>
      <div class="field inline" style="max-width: 160px;">
        <label>Companion name</label>
        <input type="text" id="companionName" placeholder="e.g. The Child">
      </div>
      <div class="field inline">
        <label>Affiliation</label>
        <select id="affiliation">
          <option value="">â€” Not set â€”</option>
          <option value="Imperial">Imperial</option>
          <option value="Rebel">Rebel</option>
          <option value="Scum">Scum</option>
          <option value="Any">Any</option>
        </select>
      </div>
    </div>
  </div>
  </div>

  <div id="statsWrap" class="hint" style="margin-top:6px; padding:6px; background:#2d2d2d; border-radius:4px; font-size:12px;"></div>

  <div class="row" style="margin-top:8px;">
    <button id="addBtn" class="primary">Add / Update</button>
    <button id="verifyBtn" class="verified">VERIFIED</button>
    <button id="imgUpgradeBtn" class="export" style="background:#0dcaf0;color:#000;">IMG UPGRADED</button>
  </div>
  <p id="pasteImageStatus" class="hint" style="margin-top:6px; min-height:18px;"></p>
    </div>
    </div>
  </div>
  </div>

  <div class="entries">
    <h2>Unverified: <span id="count">0</span> â€” Verified: <span id="verifiedCount">0</span> â€” Img Upgraded: <span id="imgUpgradeCount">0</span> â€” Total: <span id="totalCount">0</span></h2>
    <div id="list"></div>
  </div>

  <script>
    function normalizeAbilityText(s) {
      if (!s || typeof s !== 'string') return s;
      return s
        .replace(/\bHEAVYWEAPON\b/gi, 'HEAVY WEAPON')
        .replace(/\bFORCEUSER\b/gi, 'FORCE USER')
        .replace(/\bpower token\b/gi, 'Power Token');
    }

    const cardSelect = document.getElementById('cardSelect');
    const cardName = document.getElementById('cardName');
    const subnameInput = document.getElementById('subname');
    const abilityText = document.getElementById('abilityText');
    const keywords = document.getElementById('keywords');
    const costInput = document.getElementById('cost');
    const subCostInput = document.getElementById('subCost');
    const healthInput = document.getElementById('health');
    const speedInput = document.getElementById('speed');
    const passivesSelect = document.getElementById('passivesSelect');
    const passivesAddBtn = document.getElementById('passivesAdd');
    const passivesListEl = document.getElementById('passivesList');
    const figuresInput = document.getElementById('figures');
    const attackTypeSelect = document.getElementById('attackType');
    const attackDiceSelect = document.getElementById('attackDiceSelect');
    const attackDiceAddBtn = document.getElementById('attackDiceAdd');
    const attackDiceListEl = document.getElementById('attackDiceList');
    const defenseSelect = document.getElementById('defenseSelect');
    const defenseAddBtn = document.getElementById('defenseAdd');
    const defenseListEl = document.getElementById('defenseList');
    const surgeSelect = document.getElementById('surgeSelect');
    const surgeAddBtn = document.getElementById('surgeAdd');
    const surgeListEl = document.getElementById('surgeList');
    const doubleSurgeSelect = document.getElementById('doubleSurgeSelect');
    const doubleSurgeAddBtn = document.getElementById('doubleSurgeAdd');
    const doubleSurgeListEl = document.getElementById('doubleSurgeList');
    const attachmentCheckbox = document.getElementById('attachment');
    const companionCheckbox = document.getElementById('companion');
    const companionNameInput = document.getElementById('companionName');
    const eliteCheckbox = document.getElementById('elite');
    const affiliationSelect = document.getElementById('affiliation');
    const addBtn = document.getElementById('addBtn');
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const verifiedCountEl = document.getElementById('verifiedCount');
    const totalCountEl = document.getElementById('totalCount');

    const VERIFIED_KEY = 'dc-verified';
    let verified = new Set(JSON.parse(localStorage.getItem(VERIFIED_KEY) || '[]'));
    let names = [];
    let cards = {};
    let dcStats = {};
    let dcImages = {};
    let companionNames = new Set();

    function addChip(container, value, label) {
      if (!value) return;
      const span = document.createElement('span');
      span.className = 'chip';
      span.dataset.value = value;
      span.textContent = label || value;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = 'Ã—';
      btn.setAttribute('aria-label', 'Remove');
      btn.addEventListener('click', () => span.remove());
      span.appendChild(btn);
      container.appendChild(span);
    }

    function getChipValues(container) {
      return Array.from(container.querySelectorAll('.chip')).map((el) => el.dataset.value);
    }

    function setChipList(container, values, labelByValue) {
      container.innerHTML = '';
      (values || []).forEach((v) => addChip(container, v, labelByValue ? (labelByValue[v] || v) : v));
    }

    const SURGE_LABELS = {
      'damage 1': '+1 Hit', 'damage 2': '+2 Hits',
      'damage 1, accuracy 1': '+1 Hit, +1 Accuracy', 'damage 1, accuracy 2': '+1 Hit, +2 Accuracy',
      'damage 1, cleave 1': '+1 Hit, Cleave 1', 'damage 1, pierce 1': '+1 Hit, Pierce 1',
      'damage 1, weaken': '+1 Hit, Weaken',
      'damage 2, accuracy 1': '+2 Hits, +1 Accuracy', 'damage 2, hide': '+2 Hits, Hide',
      'accuracy 1': '+1 Accuracy', 'accuracy 2': '+2 Accuracy', 'accuracy 3': '+3 Accuracy',
      'accuracy 1, damage 1': '+1 Accuracy, +1 Hit', 'accuracy 1, pierce 1': '+1 Accuracy, Pierce 1',
      'accuracy 2, damage 1': '+2 Accuracy, +1 Hit', 'accuracy 2, damage 2': '+2 Accuracy, +2 Hits',
      'accuracy 2, pierce 1': '+2 Accuracy, Pierce 1', 'accuracy 2, weaken': '+2 Accuracy, Weaken',
      'accuracy 2, recover 1': '+2 Accuracy, Recover 1', 'accuracy 3, pierce 1': '+3 Accuracy, Pierce 1',
      'pierce 1': 'Pierce 1', 'pierce 2': 'Pierce 2', 'pierce 3': 'Pierce 3',
      'pierce 1, accuracy 2': 'Pierce 1, +2 Accuracy', 'pierce 1, hide': 'Pierce 1, Hide',
      'pierce 1, weaken': 'Pierce 1, Weaken',
      'blast 1': 'Blast 1', 'blast 2': 'Blast 2', 'blast 3 (2 surges)': 'Blast 3 (2 surges)',
      'blast 1, cleave 1': 'Blast 1, Cleave 1', 'blast 1, recover 1': 'Blast 1 Recover 1',
      'cleave 1': 'Cleave 1', 'cleave 2': 'Cleave 2',
      'cancel 1': 'Cancel 1', 'cancel 2': 'Cancel 2',
      'bleed': 'Bleed', 'stun': 'Stun', 'weaken': 'Weaken', 'hide': 'Hide',
      'stun, pierce 1': 'Stun, Pierce 1', 'stun, evade token': 'Stun, Evade Token',
      'weaken, focus': 'Weaken, Focus',
      'focus': 'Focus', 'surge 1': '+1 Surge', 'evade': 'Evade',
      'hit token': 'Hit Token', 'hit token 2': '2 Hit Tokens',
      'block token': 'Block Token', 'Block 1': '+1 Block', 'block 2': '+2 Block',
      'evade token': 'Evade Token', 'power token': 'Power Token',
      'recover 1': 'Recover 1', 'recover 2': 'Recover 2', 'recover 3': 'Recover 3',
      'recover 1 block token': 'Recover 1 Block Token',
      'movement 2': '+2 Movement',
    };
    const DICE_LABELS = { red: 'Red', blue: 'Blue', yellow: 'Yellow', green: 'Green', special: 'Special' };
    const DEFENSE_LABELS = { white: 'White', black: 'Black' };

    attackDiceAddBtn.addEventListener('click', () => {
      const v = attackDiceSelect.value;
      if (!v) return;
      addChip(attackDiceListEl, v, DICE_LABELS[v] || v);
    });
    defenseAddBtn.addEventListener('click', () => {
      const v = defenseSelect.value;
      if (!v) return;
      addChip(defenseListEl, v, DEFENSE_LABELS[v] || v);
    });
    surgeAddBtn.addEventListener('click', () => {
      const v = surgeSelect.value;
      if (!v) return;
      addChip(surgeListEl, v, SURGE_LABELS[v] || v);
      surgeSelect.value = '';
    });
    doubleSurgeAddBtn.addEventListener('click', () => {
      const v = doubleSurgeSelect.value;
      if (!v) return;
      addChip(doubleSurgeListEl, v, SURGE_LABELS[v] || v);
      doubleSurgeSelect.value = '';
    });
    passivesAddBtn.addEventListener('click', () => {
      let v = passivesSelect.value;
      if (!v) return;
      if (v === '__other__') {
        v = (prompt('Enter passive name (e.g. Custom Trait)') || '').trim();
        if (!v) return;
      }
      addChip(passivesListEl, v, v);
      passivesSelect.value = '';
    });

    let imageUpgrades = { description: 'Tracks which cards have had their images upgraded with better quality versions', dc_figures: [], dc_upgrades: [], cc: [], companions: [] };

    function isImageUpgraded(name) {
      if (imageUpgrades.dc_figures.includes(name)) return true;
      if (imageUpgrades.dc_upgrades.includes(name)) return true;
      if (imageUpgrades.companions.includes(name)) return true;
      return false;
    }

    function getImageUpgradeCount() {
      return names.filter((n) => isImageUpgraded(n)).length;
    }

    function toggleImageUpgrade(name) {
      if (!name) return;
      const isUpgrade = name.startsWith('[');
      const isCompanion = companionNames.has(name);
      const list = isCompanion ? 'companions' : isUpgrade ? 'dc_upgrades' : 'dc_figures';
      const idx = imageUpgrades[list].indexOf(name);
      if (idx >= 0) {
        imageUpgrades[list].splice(idx, 1);
      } else {
        imageUpgrades[list].push(name);
        imageUpgrades[list].sort();
      }
      saveImageUpgrades();
      render();
    }

    async function saveImageUpgrades() {
      try {
        await fetch('/api/save-image-upgrades', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(imageUpgrades),
        });
      } catch (_) {}
    }

    function saveVerified() {
      localStorage.setItem(VERIFIED_KEY, JSON.stringify([...verified]));
      saveVerifiedToFile(false);
    }

    async function saveVerifiedToFile(silent = false) {
      try {
        const r = await fetch('/api/save-dc-verified', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ verified: [...verified] }),
        });
        const text = await r.text();
        let j;
        try { j = JSON.parse(text); } catch { j = {}; }
        if (r.ok && j.ok) return;
        if (!silent) alert('Save verified failed: ' + (j.error || r.status + ' ' + text.slice(0, 80)));
      } catch (e) {
        if (!silent) alert('Save verified failed: ' + e.message + '. Restart npm run cc-review?');
      }
    }

    function getVerifiedCount() {
      return names.filter((n) => verified.has(n)).length;
    }
    function getUnverifiedCount() {
      return names.length - getVerifiedCount();
    }

    function getUnverifiedCards() {
      return names.filter((n) => !verified.has(n)).sort((a, b) => {
        const aCompanion = companionNames.has(a) ? 2 : 0;
        const bCompanion = companionNames.has(b) ? 2 : 0;
        if (aCompanion !== bCompanion) return aCompanion - bCompanion;
        const aSkirmish = a.startsWith('[') ? 1 : 0;
        const bSkirmish = b.startsWith('[') ? 1 : 0;
        if (aSkirmish !== bSkirmish) return aSkirmish - bSkirmish;
        return a.localeCompare(b);
      });
    }

    function updateCardSelect() {
      const unverified = getUnverifiedCards();
      cardSelect.innerHTML = '<option value="">â€” Select or type below â€”</option>';
      unverified.forEach((n) => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        cardSelect.appendChild(opt);
      });
    }

    function updateCardImage() {
      const name = (cardName.value || cardSelect.value || '').trim();
      const img = document.getElementById('cardImg');
      const placeholder = document.getElementById('cardImgPlaceholder');
      const badge = document.getElementById('imgUpgradeBadge');
      if (!name) {
        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.textContent = 'Select a card';
        badge.style.display = 'none';
        return;
      }
      const apiUrl = '/api/dc-image/' + encodeURIComponent(name) + '?t=' + Date.now();
      img.src = apiUrl;
      img.alt = name;
      img.style.display = 'block';
      img.onload = () => { placeholder.style.display = 'none'; };
      img.onerror = () => {
        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.textContent = 'No image';
      };
      placeholder.style.display = 'none';
      badge.style.display = isImageUpgraded(name) ? 'block' : 'none';
    }

    function updateStatsDisplay() {
      const name = (cardName.value || cardSelect.value || '').trim();
      const wrap = document.getElementById('statsWrap');
      if (!wrap) return;
      const stats = dcStats[name] || dcStats[name.replace(/\s*\[.*\]\s*$/, '')];
      if (!stats) {
        wrap.textContent = '';
        wrap.style.display = 'none';
        return;
      }
      wrap.style.display = 'block';
      const a = stats.attack;
      const attackStr = a ? (Array.isArray(a.dice) ? a.dice.join(', ') : a.dice) : 'â€”';
      wrap.innerHTML = 'Stats (from dc-stats): Cost ' + (stats.cost ?? 'â€”') + ' Â· Health ' + (stats.health ?? 'â€”') + ' Â· Figures ' + (stats.figures ?? 'â€”') + ' Â· Speed ' + (stats.speed ?? 'â€”') + ' Â· Attack ' + attackStr + ' Â· Defense ' + (stats.defense ?? 'â€”') + (stats.specials && stats.specials.length ? ' Â· Specials: ' + stats.specials.join(', ') : '');
    }

    function updateAbilityTextState() {
      const val = (abilityText.value || '').trim();
      const emptyOrTbd = !val || /TBD|^â€”\s*$/.test(val);
      abilityText.classList.toggle('empty-or-tbd', emptyOrTbd);
      const hint = document.getElementById('abilityHintEmpty');
      if (hint) hint.style.display = emptyOrTbd ? 'block' : 'none';
    }

    function onCardChange() {
      const name = (cardName.value || cardSelect.value || '').trim();
      updateCardImage();
      updateStatsDisplay();
      const statsFallback = name && (dcStats[name] || dcStats[name.replace(/\s*\[.*\]\s*$/, '')]);
      if (name && cards[name]) {
        const card = cards[name];
        abilityText.value = card.abilityText || '';
        keywords.value = Array.isArray(card.keywords) ? card.keywords.join(', ') : (card.keywords || '');
        subnameInput.value = card.subname || '';
        costInput.value = card.cost !== undefined && card.cost !== null && card.cost !== '' ? Number(card.cost) : (statsFallback?.cost != null ? statsFallback.cost : '');
        subCostInput.value = card.subCost !== undefined && card.subCost !== null && card.subCost !== '' ? Number(card.subCost) : '';
        healthInput.value = card.health !== undefined && card.health !== null && card.health !== '' ? Number(card.health) : (statsFallback?.health != null ? statsFallback.health : '');
        speedInput.value = card.speed !== undefined && card.speed !== null && card.speed !== '' ? Number(card.speed) : (statsFallback?.speed != null ? statsFallback.speed : '');
        const passivesRaw = card.passives ?? statsFallback?.passives;
        const passivesArr = passivesRaw == null ? [] : (Array.isArray(passivesRaw) ? passivesRaw : String(passivesRaw).split(/\s*,\s*/).map((s) => s.trim()).filter(Boolean));
        setChipList(passivesListEl, passivesArr);
        figuresInput.value = card.figures !== undefined && card.figures !== null && card.figures !== '' ? Number(card.figures) : (statsFallback?.figures != null ? statsFallback.figures : '');
        const a = card.attack || statsFallback?.attack;
        if (a) {
          const dice = Array.isArray(a.dice) ? a.dice : (a.dice ? [a.dice] : []);
          setChipList(attackDiceListEl, dice, DICE_LABELS);
          attackTypeSelect.value = (a.type === 'melee' || a.type === 'range') ? a.type : '';
        } else {
          setChipList(attackDiceListEl, []);
          attackTypeSelect.value = '';
        }
        const def = card.defense != null ? card.defense : statsFallback?.defense;
        const defenseArr = def == null ? [] : (Array.isArray(def) ? def : [def]);
        setChipList(defenseListEl, defenseArr, DEFENSE_LABELS);
        const surgeArr = card.surgeAbilities || statsFallback?.surgeAbilities || [];
        setChipList(surgeListEl, surgeArr, SURGE_LABELS);
        const doubleSurgeArr = card.doubleSurgeAbilities || statsFallback?.doubleSurgeAbilities || [];
        setChipList(doubleSurgeListEl, doubleSurgeArr, SURGE_LABELS);
        attachmentCheckbox.checked = !!(card.attachment);
        companionCheckbox.checked = !!(card.companion);
        companionNameInput.value = typeof card.companion === 'string' ? card.companion : '';
        const aff = card.affiliation || '';
        affiliationSelect.value = (aff === 'Mercenary' ? 'Scum' : aff === 'Neutral' ? 'Any' : aff) || '';
        eliteCheckbox.checked = card.elite === true || (card.elite !== false && /\(Elite\)\s*$/i.test(name));
      } else {
        abilityText.value = '';
        keywords.value = '';
        subnameInput.value = '';
        costInput.value = statsFallback?.cost != null ? statsFallback.cost : '';
        subCostInput.value = '';
        healthInput.value = statsFallback?.health != null ? statsFallback.health : '';
        speedInput.value = statsFallback?.speed != null ? statsFallback.speed : '';
        setChipList(passivesListEl, statsFallback?.passives ? (Array.isArray(statsFallback.passives) ? statsFallback.passives : [statsFallback.passives]) : []);
        figuresInput.value = statsFallback?.figures != null ? statsFallback.figures : '';
        const a = statsFallback?.attack;
        const dice = a && (Array.isArray(a.dice) ? a.dice : (a.dice ? [a.dice] : [])) || [];
        setChipList(attackDiceListEl, dice, DICE_LABELS);
        attackTypeSelect.value = (a && (a.type === 'melee' || a.type === 'range')) ? a.type : '';
        const def = statsFallback?.defense;
        setChipList(defenseListEl, def == null ? [] : (Array.isArray(def) ? def : [def]), DEFENSE_LABELS);
        setChipList(surgeListEl, statsFallback?.surgeAbilities || [], SURGE_LABELS);
        setChipList(doubleSurgeListEl, statsFallback?.doubleSurgeAbilities || [], SURGE_LABELS);
        attachmentCheckbox.checked = false;
        companionCheckbox.checked = false;
        companionNameInput.value = '';
        eliteCheckbox.checked = /\(Elite\)\s*$/i.test((cardName.value || cardSelect.value || '').trim());
        affiliationSelect.value = '';
      }
      updateAbilityTextState();
    }

    cardSelect.addEventListener('change', () => {
      cardName.value = cardSelect.value || '';
      onCardChange();
    });
    cardName.addEventListener('input', () => {
      const v = cardName.value.trim();
      if (names.includes(v)) cardSelect.value = v;
      else cardSelect.value = '';
      onCardChange();
    });
    abilityText.addEventListener('input', updateAbilityTextState);
    updateAbilityTextState();

    function getFigureStatsFromForm() {
      const speedVal = speedInput.value.trim();
      const speedNum = speedVal === '' ? undefined : (parseInt(speedVal, 10) || 0);
      const passivesArr = getChipValues(passivesListEl);
      const passives = passivesArr.length ? passivesArr : undefined;
      const figuresVal = figuresInput.value.trim();
      const figuresNum = figuresVal === '' ? undefined : (parseInt(figuresVal, 10) || 0);
      const attackDice = getChipValues(attackDiceListEl);
      const attackType = attackTypeSelect.value;
      const attack = attackDice.length
        ? { dice: attackDice, ...(attackType === 'range' || attackType === 'melee' ? { type: attackType } : {}) }
        : undefined;
      const defenseArr = getChipValues(defenseListEl);
      const defense = defenseArr.length ? defenseArr : undefined;
      const surgeAbilities = getChipValues(surgeListEl);
      const doubleSurgeAbilities = getChipValues(doubleSurgeListEl);
      return {
        speed: speedNum,
        passives,
        figures: figuresNum,
        attack,
        defense,
        surgeAbilities: surgeAbilities.length ? surgeAbilities : undefined,
        doubleSurgeAbilities: doubleSurgeAbilities.length ? doubleSurgeAbilities : undefined,
      };
    }

    addBtn.addEventListener('click', () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) { alert('Enter a card name'); return; }
      const kw = keywords.value.trim().split(/\s*,\s*/).filter(Boolean);
      const costVal = costInput.value.trim();
      const costNum = costVal === '' ? undefined : (parseInt(costVal, 10) || 0);
      const subCostVal = subCostInput.value.trim();
      const subCostNum = subCostVal === '' ? undefined : (parseInt(subCostVal, 10) || 0);
      const healthVal = healthInput.value.trim();
      const healthNum = healthVal === '' ? undefined : (parseInt(healthVal, 10) || 0);
      const existing = cards[name] || {};
      const fig = getFigureStatsFromForm();
      cards[name] = {
        abilityText: normalizeAbilityText(abilityText.value.trim()) || '',
        keywords: kw,
        subname: subnameInput.value.trim() || undefined,
        cost: costNum,
        subCost: subCostNum,
        health: healthNum,
        speed: fig.speed,
        passives: fig.passives,
        figures: fig.figures,
        attack: fig.attack,
        defense: fig.defense,
        surgeAbilities: fig.surgeAbilities,
        doubleSurgeAbilities: fig.doubleSurgeAbilities,
        attachment: attachmentCheckbox.checked,
        companion: companionCheckbox.checked ? (companionNameInput.value.trim() || true) : undefined,
        elite: eliteCheckbox.checked || undefined,
        affiliation: affiliationSelect.value || undefined,
        isIACPVariant: existing.isIACPVariant,
      };
      render();
      saveToFile(true);
    });

    document.getElementById('verifyBtn').addEventListener('click', () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) { alert('Select a card to verify'); return; }
      const kw = keywords.value.trim().split(/\s*,\s*/).filter(Boolean);
      const costVal = costInput.value.trim();
      const costNum = costVal === '' ? undefined : (parseInt(costVal, 10) || 0);
      const subCostVal = subCostInput.value.trim();
      const subCostNum = subCostVal === '' ? undefined : (parseInt(subCostVal, 10) || 0);
      const healthVal = healthInput.value.trim();
      const healthNum = healthVal === '' ? undefined : (parseInt(healthVal, 10) || 0);
      const existing = cards[name] || {};
      const fig = getFigureStatsFromForm();
      cards[name] = {
        abilityText: normalizeAbilityText(abilityText.value.trim()) || '',
        keywords: kw,
        subname: subnameInput.value.trim() || undefined,
        cost: costNum,
        subCost: subCostNum,
        health: healthNum,
        speed: fig.speed,
        passives: fig.passives,
        figures: fig.figures,
        attack: fig.attack,
        defense: fig.defense,
        surgeAbilities: fig.surgeAbilities,
        doubleSurgeAbilities: fig.doubleSurgeAbilities,
        attachment: attachmentCheckbox.checked,
        companion: companionCheckbox.checked ? (companionNameInput.value.trim() || true) : undefined,
        elite: eliteCheckbox.checked || undefined,
        affiliation: affiliationSelect.value || undefined,
        isIACPVariant: existing.isIACPVariant,
      };
      verified.add(name);
      saveVerified();
      saveToFile(true);
      render();
      const nextOpt = cardSelect.options[1];
      if (nextOpt && nextOpt.value) {
        cardSelect.value = nextOpt.value;
        cardName.value = nextOpt.value;
        onCardChange();
      } else {
        cardSelect.value = '';
        cardName.value = '';
        onCardChange();
      }
    });

    document.getElementById('imgUpgradeBtn').addEventListener('click', () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) return alert('Select a card first');
      toggleImageUpgrade(name);
      const badge = document.getElementById('imgUpgradeBadge');
      badge.style.display = isImageUpgraded(name) ? 'block' : 'none';
    });

    const statusEl = document.getElementById('pasteImageStatus');

    async function savePastedImage(blob, name) {
      if (!name || !blob) return false;
      const r = await fetch('/api/save-dc-image?name=' + encodeURIComponent(name), {
        method: 'POST',
        body: blob,
        headers: { 'Content-Type': blob.type || 'image/png' },
      });
      const j = await r.json().catch(() => ({}));
      if (j.ok) {
        statusEl.textContent = 'Image updated.';
        updateCardImage();
        setTimeout(() => { statusEl.textContent = ''; }, 3000);
        return true;
      }
      statusEl.textContent = j.error || 'Save failed (' + r.status + ').';
      return false;
    }

    function getImageFromClipboardItems(items) {
      if (!items) return null;
      for (const item of items) {
        if (item.kind !== 'file') continue;
        const type = (item.type || '').toLowerCase();
        if (type.startsWith('image/')) return item.getAsFile();
      }
      return null;
    }

    document.addEventListener('paste', async (e) => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) return;
      const blob = getImageFromClipboardItems(e.clipboardData && e.clipboardData.items);
      if (!blob) return;
      e.preventDefault();
      statusEl.textContent = 'Savingâ€¦';
      try {
        await savePastedImage(blob, name);
      } catch (err) {
        statusEl.textContent = 'Save failed: ' + (err && err.message ? err.message : 'unknown');
      }
    });

    document.getElementById('pasteImageBtn').addEventListener('click', async () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) {
        statusEl.textContent = 'Select a card first.';
        return;
      }
      statusEl.textContent = 'Reading clipboardâ€¦';
      let blob = null;
      try {
        const items = await navigator.clipboard.read();
        for (const item of items) {
          for (const type of item.types || []) {
            if (type === 'image/png' || type === 'image/jpeg' || type === 'image/jpg') {
              blob = await item.getType(type);
              break;
            }
          }
          if (blob) break;
        }
      } catch (e) {
        statusEl.textContent = 'Clipboard permission denied or not supported. Try: select the card, copy an image, then press Ctrl+V (or Cmd+V) to paste.';
        return;
      }
      if (!blob) {
        statusEl.textContent = 'No image in clipboard. Copy an image first, then click again or press Ctrl+V.';
        return;
      }
      statusEl.textContent = 'Savingâ€¦';
      try {
        await savePastedImage(blob, name);
      } catch (e) {
        statusEl.textContent = 'Save failed: ' + e.message + '. Is npm run cc-review running?';
      }
    });

    function render() {
      updateCardSelect();
      listEl.innerHTML = '';
      countEl.textContent = getUnverifiedCount();
      verifiedCountEl.textContent = getVerifiedCount();
      document.getElementById('imgUpgradeCount').textContent = getImageUpgradeCount();
      totalCountEl.textContent = names.length;
      const unverified = getUnverifiedCards();
      unverified.forEach((name) => {
        const data = cards[name] || {};
        const kwStr = Array.isArray(data.keywords) ? data.keywords.join(', ') : (data.keywords || '');
        const div = document.createElement('div');
        div.className = 'entry';
        const costStr = data.cost !== undefined && data.cost !== null ? data.cost + ' pts' : 'â€”';
        const subCostStr = data.subCost !== undefined && data.subCost !== null ? data.subCost + ' VP/fig' : '';
        const healthStr = data.health !== undefined && data.health !== null ? data.health + ' HP' : '';
        const attStr = data.attachment ? ' Â· Attachment' : '';
        const compStr = data.companion ? (' Â· Companion' + (typeof data.companion === 'string' ? ` (${data.companion})` : '')) : '';
        const eliteStr = data.elite ? ' Â· Elite' : '';
        const affStr = data.affiliation ? ' Â· ' + data.affiliation : '';
        const imgBadge = isImageUpgraded(name) ? '<span style="background:#0dcaf0;color:#000;font-size:10px;padding:1px 5px;border-radius:3px;margin-left:6px;">IMG</span>' : '';
        const mid = [costStr, subCostStr, healthStr, kwStr || 'â€”'].filter(Boolean).join(' Â· ');
        div.innerHTML = `<strong>${name}</strong>${imgBadge} <span>${mid}${attStr}${compStr}${eliteStr}${affStr}</span> <button data-name="${name.replace(/"/g, '&quot;')}">Remove</button>`;
        div.querySelector('button').addEventListener('click', (e) => {
          e.stopPropagation();
          delete cards[name];
          render();
        });
        div.style.cursor = 'pointer';
        div.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') return;
          cardSelect.value = name;
          cardName.value = name;
          onCardChange();
        });
        listEl.appendChild(div);
      });
    }

    async function saveToFile(silent = false) {
      const out = { source: 'DC Effect Editor', cards };
      try {
        const r = await fetch('/api/save-dc-effects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(out),
        });
        const j = await r.json();
        if (j.ok && !silent) alert('Saved to data/dc-effects.json');
        else if (!j.ok) alert('Save failed: ' + (j.error || r.status));
      } catch (e) {
        alert('Save failed: ' + e.message + '. Run npm run cc-review first.');
      }
    }

    render();
    (async () => {
      try {
        const ri = await fetch('/data/dc-images.json');
        if (ri.ok) {
          const di = await ri.json();
          dcImages = di.dcImages || di || {};
        }
      } catch (_) {}
      try {
        const rc = await fetch('/data/companion-images.json');
        if (rc.ok) {
          const ci = await rc.json();
          const companionImages = ci.companionImages || ci || {};
          companionNames = new Set(Object.keys(companionImages));
          Object.assign(dcImages, companionImages);
        }
      } catch (_) {}
      names = Object.keys(dcImages).filter((k) => dcImages[k]).sort((a, b) => {
        const aCompanion = companionNames.has(a) ? 2 : 0;
        const bCompanion = companionNames.has(b) ? 2 : 0;
        if (aCompanion !== bCompanion) return aCompanion - bCompanion;
        const aSkirmish = a.startsWith('[') ? 1 : 0;
        const bSkirmish = b.startsWith('[') ? 1 : 0;
        if (aSkirmish !== bSkirmish) return aSkirmish - bSkirmish;
        return a.localeCompare(b);
      });
      try {
        const r = await fetch('/data/dc-effects.json');
        if (r.ok) {
          const d = await r.json();
          if (d.cards && Object.keys(d.cards).length > 0) cards = d.cards;
        }
      } catch (_) {}
      try {
        const rv = await fetch('/data/dc-verified.json');
        if (rv.ok) {
          const dv = await rv.json();
          if (dv.verified && Array.isArray(dv.verified)) {
            verified = new Set(dv.verified);
            localStorage.setItem(VERIFIED_KEY, JSON.stringify([...verified]));
          }
        }
      } catch (_) {}
      try {
        const rs = await fetch('/data/dc-stats.json');
        if (rs.ok) {
          const ds = await rs.json();
          dcStats = ds.dcStats || ds || {};
        }
      } catch (_) {}
      try {
        const ru = await fetch('/data/dc-image-upgrades.json');
        if (ru.ok) {
          const du = await ru.json();
          if (du.dc_figures) imageUpgrades = du;
        }
      } catch (_) {}
      render();
      const firstOpt = cardSelect.options[1];
      if (firstOpt && firstOpt.value) {
        cardSelect.value = firstOpt.value;
        cardName.value = firstOpt.value;
        onCardChange();
      }
    })();
  </script>
</body>
</html>
