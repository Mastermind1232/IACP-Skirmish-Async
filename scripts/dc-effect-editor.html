<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IA Skirmish — DC Effect Editor</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; padding: 20px; background: #1e1e1e; color: #eee; max-width: 1600px; }
    h1 { font-size: 1.3rem; margin-bottom: 8px; }
    .hint { font-size: 12px; color: #999; margin-bottom: 16px; }
    .main { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    .card-img-wrap { flex-shrink: 0; width: 328px; height: 485px; background: #2d2d2d; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .card-img-wrap img { width: 100%; height: 100%; object-fit: contain; object-position: center; }
    .card-img-wrap .placeholder { color: #666; font-size: 13px; text-align: center; padding: 16px; }
    .form-wrap { flex: 1; min-width: 280px; display: flex; flex-direction: column; }
    .form-columns { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    .form-main { flex: 1; min-width: 280px; }
    .form-stats { flex: 0 0 400px; min-width: 340px; }
    label { display: block; margin-top: 12px; margin-bottom: 4px; font-weight: 500; }
    select, input, textarea { width: 100%; padding: 8px 12px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 14px; }
    textarea { min-height: 80px; font-family: inherit; resize: vertical; }
    .row { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    button.primary { background: #0d6efd; color: #fff; }
    button.primary:hover { background: #0b5ed7; }
    button.export { background: #198754; color: #fff; }
    button.export:hover { background: #157347; }
    button.verified { background: #dc3545; color: #fff; }
    button.verified:hover { background: #bb2d3b; }
    .entries { margin-top: 24px; }
    .entries h2 { font-size: 1rem; margin-bottom: 8px; }
    .entry { padding: 8px 12px; margin-bottom: 6px; background: #2d2d2d; border-radius: 4px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
    .entry span { color: #aaa; }
    .entry button { padding: 4px 10px; font-size: 12px; background: #dc3545; }
    .entry button:hover { background: #bb2d3b; }
    .dup-panel { margin-top: 16px; padding: 12px; background: #2d2d2d; border-radius: 8px; border: 1px solid #555; }
    .dup-panel h3 { font-size: 0.95rem; margin: 0 0 8px 0; }
    .dup-group { margin-bottom: 12px; padding: 8px; background: #1e1e1e; border-radius: 4px; }
    .dup-group .path { font-size: 11px; color: #888; margin-bottom: 4px; word-break: break-all; }
    .dup-card-line { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .dup-card-line .iacp-badge { background: #198754; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
    button.iacp { background: #6f42c1; color: #fff; }
    button.iacp:hover { background: #5a32a3; }
    .form-section { margin-top: 14px; padding-top: 12px; border-top: 1px solid #444; }
    .form-section-title { font-size: 12px; font-weight: 600; color: #aaa; margin-bottom: 8px; }
    .form-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; margin-top: 8px; }
    .field { display: flex; flex-direction: column; gap: 2px; }
    .field.inline { flex: 0 0 auto; min-width: 72px; }
    .field.wide { flex: 1; min-width: 120px; }
    .field.grow { flex: 1; min-width: 160px; }
    .field label { margin-top: 0; font-size: 12px; }
    .field .hint { margin: 0; font-size: 11px; }
    .form-wrap .form-row input[type="number"], .form-wrap .form-row select { width: 100%; }
    .form-wrap .form-row .field.inline input { width: 100%; }
    .chip-list { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; min-height: 32px; padding: 4px 0; }
    .chip { display: inline-flex; align-items: center; gap: 4px; background: #444; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    .chip button { background: none; border: none; color: #999; cursor: pointer; padding: 0 2px; font-size: 16px; line-height: 1; }
    .chip button:hover { color: #fff; }
    .add-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .add-row select { width: auto; min-width: 120px; }
    #surgeSelect { min-width: 240px; }
    #passivesSelect { min-width: 220px; }
    .form-row-surge-passives { flex-direction: column; align-items: stretch; gap: 16px; }
    .form-row-surge-passives .field-surge { max-width: 100%; }
    .form-row-surge-passives .field-passives { max-width: 100%; margin-left: 0; }
    button.secondary-btn { padding: 6px 12px; font-size: 12px; background: #444; color: #eee; border: 1px solid #555; border-radius: 4px; cursor: pointer; }
    button.secondary-btn:hover { background: #555; }
  </style>
</head>
<body>
  <h1>IA Skirmish — Deployment Card Effect Editor</h1>
  <p class="hint">Run <code>npm run cc-review</code> and open <code>http://localhost:3456/scripts/dc-effect-editor.html</code>. Shows <strong>Deployment Cards</strong> (figure DCs, Skirmish Upgrades) and <strong>Companion cards</strong>. Correct ability text and keywords, then click <strong>VERIFIED</strong>. Progress = unverified count shrinking to 0.</p>

  <div class="main">
    <div class="card-img-wrap" id="cardImgWrap">
      <div class="placeholder" id="cardImgPlaceholder">Select a card</div>
      <img id="cardImg" alt="" style="display:none">
    </div>
    <div class="form-wrap">
  <div class="form-columns">
    <div class="form-main">
  <label>Card name</label>
  <div class="form-row">
    <div class="field grow"><select id="cardSelect"><option value="">— Select or type below —</option></select></div>
    <div class="field grow"><input type="text" id="cardName" placeholder="Or type DC name manually"></div>
  </div>

  <label>Sub-name</label>
  <input type="text" id="subname" placeholder="e.g. Hero of the Rebellion, SPECTRE-1 (subtitle under card name)">
  <span class="hint" style="display:block; margin-top:2px;">Secondary title on the card; used for unique identification and some abilities (e.g. Spectre Allies).</span>

  <label>Ability text</label>
  <p class="hint" style="margin: 2px 0 4px 0;">Only the main ability text from the middle of the card. Do not include the traits line or attack/defense/surge summary—those go in Keywords and the Figure stats section below. Check for the special action symbol on the card; when present, use "Special Action (Name):" for that ability—not just "Name:"; capitalize Damage and Strain; use all-caps SMALL when referring to the unit trait. When the card shows a dice symbol (e.g. for "Damage equal to the ___ results"), spell out the result type: Hit, Surge, Block, Evade, or Damage results—never leave it as "the results".</p>
  <textarea id="abilityText" placeholder="Paste or type the card's ability text (middle section only)"></textarea>

  <label>Keywords</label>
  <input type="text" id="keywords" placeholder="e.g. Massive, Mobile (comma-separated)">

  <div class="form-row">
    <div class="field inline">
      <label>Cost</label>
      <input type="number" id="cost" placeholder="pts" min="-10" max="40" step="1">
      <span class="hint">-10 to 40</span>
    </div>
    <div class="field inline">
      <label>Sub-cost</label>
      <input type="number" id="subCost" placeholder="VP per figure" min="0" max="20" step="1">
      <span class="hint">VP per figure when one is defeated (multifigure DCs)</span>
    </div>
    <div class="field inline">
      <label>Health</label>
      <input type="number" id="health" placeholder="—" min="1" max="99" step="1">
    </div>
    <div class="field inline">
      <label>Speed</label>
      <input type="number" id="speed" placeholder="—" min="1" max="8" step="1">
    </div>
    <div class="field inline">
      <label>Figures</label>
      <input type="number" id="figures" placeholder="—" min="0" max="4" step="1">
    </div>
  </div>

    </div>
    <div class="form-stats">
  <div class="form-section">
    <div class="form-section-title">Figure stats (Squad Upgrades)</div>
    <div class="form-row">
      <div class="field inline" style="min-width: 120px;">
        <label>Attack type</label>
        <select id="attackType">
          <option value="">— Not set —</option>
          <option value="range">Ranged</option>
          <option value="melee">Melee</option>
        </select>
      </div>
      <div class="field wide">
        <label>Attack dice</label>
        <div class="add-row">
          <select id="attackDiceSelect">
            <option value="">Add die…</option>
            <option value="red">Red</option>
            <option value="blue">Blue</option>
            <option value="yellow">Yellow</option>
            <option value="green">Green</option>
          </select>
          <button type="button" id="attackDiceAdd" class="secondary-btn">Add</button>
        </div>
        <div id="attackDiceList" class="chip-list"></div>
      </div>
      <div class="field wide">
        <label>Defense die</label>
        <div class="add-row">
          <select id="defenseSelect">
            <option value="">Add die…</option>
            <option value="white">White</option>
            <option value="black">Black</option>
          </select>
          <button type="button" id="defenseAdd" class="secondary-btn">Add</button>
        </div>
        <div id="defenseList" class="chip-list"></div>
      </div>
    </div>
    <div class="form-row form-row-surge-passives">
      <div class="field field-surge">
        <label>Surge abilities</label>
        <div class="add-row">
          <select id="surgeSelect">
            <option value="">Add surge…</option>
            <option value="damage 1">+1 Hit</option>
            <option value="damage 2">+2 Hit</option>
            <option value="accuracy 1, pierce 1">+1 Accuracy, Pierce 1</option>
            <option value="accuracy 2">+2 Accuracy</option>
            <option value="accuracy 3">+3 Accuracy</option>
            <option value="blast 1">Blast 1</option>
            <option value="blast 2">Blast 2</option>
            <option value="cancel 1">Cancel 1</option>
            <option value="cleave 1">Cleave 1</option>
            <option value="cleave 2">Cleave 2</option>
            <option value="damage 1, cleave 1">+1 Hit, Cleave 1</option>
            <option value="blast 1, cleave 1">Blast 1, Cleave 1</option>
            <option value="focus">Focus</option>
            <option value="hit token">Hit Token</option>
            <option value="block token">Block Token</option>
            <option value="recover 1 block token">Recover 1 Block Token</option>
            <option value="evade token">Evade Token</option>
            <option value="pierce 1">Pierce 1</option>
            <option value="pierce 2">Pierce 2</option>
            <option value="pierce 3">Pierce 3</option>
            <option value="recover 1">Recover 1</option>
            <option value="recover 2">Recover 2</option>
            <option value="recover 3">Recover 3</option>
            <option value="accuracy 2, pierce 1">+2 Accuracy, Pierce 1</option>
            <option value="damage 1, accuracy 1">+1 Hit, +1 Accuracy</option>
            <option value="weaken, focus">Weaken, Focus</option>
            <option value="bleed">Bleed</option>
            <option value="stun">Stun</option>
            <option value="weaken">Weaken</option>
          </select>
          <button type="button" id="surgeAdd" class="secondary-btn">Add</button>
        </div>
        <div id="surgeList" class="chip-list"></div>
      </div>
      <div id="passivesField" class="field field-passives">
        <label>Passives</label>
        <div class="add-row">
          <select id="passivesSelect">
            <option value="">Add passive…</option>
            <option value="Reach">Reach</option>
            <option value="Block 1">Block 1</option>
            <option value="Block 2">Block 2</option>
            <option value="+1 Evade">+1 Evade</option>
            <option value="+1 Hit">+1 Hit</option>
            <option value="+2 Hit">+2 Hit</option>
            <option value="Bleed">Bleed</option>
            <option value="Blast 1">Blast 1</option>
            <option value="Priority Target">Priority Target</option>
            <option value="+1 Accuracy">+1 Accuracy</option>
            <option value="+2 Accuracy">+2 Accuracy</option>
            <option value="+3 Accuracy">+3 Accuracy</option>
            <option value="Pierce 1">Pierce 1</option>
            <option value="Pierce 2">Pierce 2</option>
            <option value="Habitat: City">Habitat: City</option>
            <option value="Habitat: Desert">Habitat: Desert</option>
            <option value="Habitat: Forest">Habitat: Forest</option>
            <option value="Habitat: Snow">Habitat: Snow</option>
            <option value="__other__">Other…</option>
          </select>
          <button type="button" id="passivesAdd" class="secondary-btn">Add</button>
        </div>
        <div id="passivesList" class="chip-list"></div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <div class="form-row" style="align-items: center;">
      <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
        <input type="checkbox" id="attachment" style="width: auto;">
        <span>Attachment</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
        <input type="checkbox" id="companion" style="width: auto;">
        <span>Companion</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
        <input type="checkbox" id="elite" style="width: auto;">
        <span>Elite</span>
      </label>
      <div class="field inline" style="max-width: 180px;">
        <label>Companion name</label>
        <input type="text" id="companionName" placeholder="e.g. The Child">
      </div>
      <div class="field inline">
        <label>Affiliation</label>
        <select id="affiliation">
          <option value="">— Not set —</option>
          <option value="Imperial">Imperial</option>
          <option value="Rebel">Rebel</option>
          <option value="Scum">Scum</option>
          <option value="Any">Any</option>
        </select>
      </div>
    </div>
  </div>

  <div id="statsWrap" class="hint" style="margin-top:12px; padding:8px; background:#2d2d2d; border-radius:4px; font-size:12px;"></div>

  <div class="row">
    <button id="addBtn" class="primary">Add / Update</button>
    <button id="verifyBtn" class="verified">VERIFIED</button>
    <button id="showDupBtn" class="iacp">Show duplicate cards</button>
    <span id="markIacpWrap" style="display:none;"><button id="markIacpBtn" class="iacp">Mark as IACP variant</button></span>
  </div>
    </div>
    </div>
  </div>
  </div>

  <div id="dupPanel" class="dup-panel" style="display: none; margin-top: 16px;">
    <h3>Suspected duplicates (same image path)</h3>
    <p class="hint">Use "Mark as IACP" to set which variant is the IACP one for priority. Saved in dc-effects.json.</p>
    <div id="dupList"></div>
  </div>

  <div class="entries">
    <h2>Unverified: <span id="count">0</span> — Verified: <span id="verifiedCount">0</span> — Total: <span id="totalCount">0</span> — Shrink unverified to 0 by clicking VERIFIED</h2>
    <div id="list"></div>
  </div>

  <script>
    const cardSelect = document.getElementById('cardSelect');
    const cardName = document.getElementById('cardName');
    const subnameInput = document.getElementById('subname');
    const abilityText = document.getElementById('abilityText');
    const keywords = document.getElementById('keywords');
    const costInput = document.getElementById('cost');
    const subCostInput = document.getElementById('subCost');
    const healthInput = document.getElementById('health');
    const speedInput = document.getElementById('speed');
    const passivesSelect = document.getElementById('passivesSelect');
    const passivesAddBtn = document.getElementById('passivesAdd');
    const passivesListEl = document.getElementById('passivesList');
    const figuresInput = document.getElementById('figures');
    const attackTypeSelect = document.getElementById('attackType');
    const attackDiceSelect = document.getElementById('attackDiceSelect');
    const attackDiceAddBtn = document.getElementById('attackDiceAdd');
    const attackDiceListEl = document.getElementById('attackDiceList');
    const defenseSelect = document.getElementById('defenseSelect');
    const defenseAddBtn = document.getElementById('defenseAdd');
    const defenseListEl = document.getElementById('defenseList');
    const surgeSelect = document.getElementById('surgeSelect');
    const surgeAddBtn = document.getElementById('surgeAdd');
    const surgeListEl = document.getElementById('surgeList');
    const attachmentCheckbox = document.getElementById('attachment');
    const companionCheckbox = document.getElementById('companion');
    const companionNameInput = document.getElementById('companionName');
    const eliteCheckbox = document.getElementById('elite');
    const affiliationSelect = document.getElementById('affiliation');
    const addBtn = document.getElementById('addBtn');
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const verifiedCountEl = document.getElementById('verifiedCount');
    const totalCountEl = document.getElementById('totalCount');

    const VERIFIED_KEY = 'dc-verified';
    let verified = new Set(JSON.parse(localStorage.getItem(VERIFIED_KEY) || '[]'));
    let names = [];
    let cards = {};
    let dcStats = {};
    let dcImages = {};
    let companionNames = new Set();

    function getDuplicateGroups() {
      const pathToCards = {};
      for (const [card, path] of Object.entries(dcImages)) {
        if (!path) continue;
        if (!pathToCards[path]) pathToCards[path] = [];
        pathToCards[path].push(card);
      }
      return Object.entries(pathToCards).filter(([, arr]) => arr.length > 1);
    }

    function addChip(container, value, label) {
      if (!value) return;
      const span = document.createElement('span');
      span.className = 'chip';
      span.dataset.value = value;
      span.textContent = label || value;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = '×';
      btn.setAttribute('aria-label', 'Remove');
      btn.addEventListener('click', () => span.remove());
      span.appendChild(btn);
      container.appendChild(span);
    }

    function getChipValues(container) {
      return Array.from(container.querySelectorAll('.chip')).map((el) => el.dataset.value);
    }

    function setChipList(container, values, labelByValue) {
      container.innerHTML = '';
      (values || []).forEach((v) => addChip(container, v, labelByValue ? (labelByValue[v] || v) : v));
    }

    const SURGE_LABELS = { 'damage 1, accuracy 1': '+1 Hit, +1 Accuracy', 'damage 1, cleave 1': '+1 Hit, Cleave 1', 'blast 1, cleave 1': 'Blast 1, Cleave 1', 'accuracy 1, pierce 1': '+1 Accuracy, Pierce 1', 'accuracy 2, pierce 1': '+2 Accuracy, Pierce 1', 'accuracy 2': '+2 Accuracy', 'accuracy 3': '+3 Accuracy', 'blast 1': 'Blast 1', 'blast 2': 'Blast 2', 'cancel 1': 'Cancel 1', 'cleave 1': 'Cleave 1', 'cleave 2': 'Cleave 2', 'damage 1': '+1 Hit', 'damage 2': '+2 Hit', 'focus': 'Focus', 'hit token': 'Hit Token', 'block token': 'Block Token', 'recover 1 block token': 'Recover 1 Block Token', 'evade token': 'Evade Token', 'pierce 1': 'Pierce 1', 'pierce 2': 'Pierce 2', 'pierce 3': 'Pierce 3', 'recover 1': 'Recover 1', 'recover 2': 'Recover 2', 'recover 3': 'Recover 3', 'weaken, focus': 'Weaken, Focus', 'bleed': 'Bleed', 'stun': 'Stun', 'weaken': 'Weaken' };
    const DICE_LABELS = { red: 'Red', blue: 'Blue', yellow: 'Yellow', green: 'Green' };
    const DEFENSE_LABELS = { white: 'White', black: 'Black' };

    attackDiceAddBtn.addEventListener('click', () => {
      const v = attackDiceSelect.value;
      if (!v) return;
      addChip(attackDiceListEl, v, DICE_LABELS[v] || v);
    });
    defenseAddBtn.addEventListener('click', () => {
      const v = defenseSelect.value;
      if (!v) return;
      addChip(defenseListEl, v, DEFENSE_LABELS[v] || v);
    });
    surgeAddBtn.addEventListener('click', () => {
      const v = surgeSelect.value;
      if (!v) return;
      addChip(surgeListEl, v, SURGE_LABELS[v] || v);
      surgeSelect.value = '';
    });
    passivesAddBtn.addEventListener('click', () => {
      let v = passivesSelect.value;
      if (!v) return;
      if (v === '__other__') {
        v = (prompt('Enter passive name (e.g. Custom Trait)') || '').trim();
        if (!v) return;
      }
      addChip(passivesListEl, v, v);
      passivesSelect.value = '';
    });

    function saveVerified() {
      localStorage.setItem(VERIFIED_KEY, JSON.stringify([...verified]));
      saveVerifiedToFile(false);
    }

    async function saveVerifiedToFile(silent = false) {
      try {
        const r = await fetch('/api/save-dc-verified', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ verified: [...verified] }),
        });
        const text = await r.text();
        let j;
        try { j = JSON.parse(text); } catch { j = {}; }
        if (r.ok && j.ok) return;
        if (!silent) alert('Save verified failed: ' + (j.error || r.status + ' ' + text.slice(0, 80)));
      } catch (e) {
        if (!silent) alert('Save verified failed: ' + e.message + '. Restart npm run cc-review?');
      }
    }

    function getVerifiedCount() {
      return names.filter((n) => verified.has(n)).length;
    }
    function getUnverifiedCount() {
      return names.length - getVerifiedCount();
    }

    function getUnverifiedCards() {
      return names.filter((n) => !verified.has(n)).sort((a, b) => {
        const aCompanion = companionNames.has(a) ? 2 : 0;
        const bCompanion = companionNames.has(b) ? 2 : 0;
        if (aCompanion !== bCompanion) return aCompanion - bCompanion;
        const aSkirmish = a.startsWith('[') ? 1 : 0;
        const bSkirmish = b.startsWith('[') ? 1 : 0;
        if (aSkirmish !== bSkirmish) return aSkirmish - bSkirmish;
        return a.localeCompare(b);
      });
    }

    function updateCardSelect() {
      const unverified = getUnverifiedCards();
      cardSelect.innerHTML = '<option value="">— Select or type below —</option>';
      unverified.forEach((n) => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        cardSelect.appendChild(opt);
      });
    }

    function updateCardImage() {
      const name = (cardName.value || cardSelect.value || '').trim();
      const img = document.getElementById('cardImg');
      const placeholder = document.getElementById('cardImgPlaceholder');
      if (!name) {
        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.textContent = 'Select a card';
        return;
      }
      const apiUrl = '/api/dc-image/' + encodeURIComponent(name) + '?t=' + Date.now();
      img.src = apiUrl;
      img.alt = name;
      img.style.display = 'block';
      img.onload = () => { placeholder.style.display = 'none'; };
      img.onerror = () => {
        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.textContent = 'No image';
      };
      placeholder.style.display = 'none';
    }

    function updateStatsDisplay() {
      const name = (cardName.value || cardSelect.value || '').trim();
      const wrap = document.getElementById('statsWrap');
      if (!wrap) return;
      const stats = dcStats[name] || dcStats[name.replace(/\s*\[.*\]\s*$/, '')];
      if (!stats) {
        wrap.textContent = '';
        wrap.style.display = 'none';
        return;
      }
      wrap.style.display = 'block';
      const a = stats.attack;
      const attackStr = a ? (Array.isArray(a.dice) ? a.dice.join(', ') : a.dice) : '—';
      wrap.innerHTML = 'Stats (from dc-stats): Cost ' + (stats.cost ?? '—') + ' · Health ' + (stats.health ?? '—') + ' · Figures ' + (stats.figures ?? '—') + ' · Speed ' + (stats.speed ?? '—') + ' · Attack ' + attackStr + ' · Defense ' + (stats.defense ?? '—') + (stats.specials && stats.specials.length ? ' · Specials: ' + stats.specials.join(', ') : '');
    }

    function onCardChange() {
      const name = (cardName.value || cardSelect.value || '').trim();
      updateCardImage();
      updateStatsDisplay();
      updateMarkIacpVisibility();
      const statsFallback = name && (dcStats[name] || dcStats[name.replace(/\s*\[.*\]\s*$/, '')]);
      if (name && cards[name]) {
        const card = cards[name];
        abilityText.value = card.abilityText || '';
        keywords.value = Array.isArray(card.keywords) ? card.keywords.join(', ') : (card.keywords || '');
        subnameInput.value = card.subname || '';
        costInput.value = card.cost !== undefined && card.cost !== null && card.cost !== '' ? Number(card.cost) : (statsFallback?.cost != null ? statsFallback.cost : '');
        subCostInput.value = card.subCost !== undefined && card.subCost !== null && card.subCost !== '' ? Number(card.subCost) : '';
        healthInput.value = card.health !== undefined && card.health !== null && card.health !== '' ? Number(card.health) : (statsFallback?.health != null ? statsFallback.health : '');
        speedInput.value = card.speed !== undefined && card.speed !== null && card.speed !== '' ? Number(card.speed) : (statsFallback?.speed != null ? statsFallback.speed : '');
        const passivesRaw = card.passives ?? statsFallback?.passives;
        const passivesArr = passivesRaw == null ? [] : (Array.isArray(passivesRaw) ? passivesRaw : String(passivesRaw).split(/\s*,\s*/).map((s) => s.trim()).filter(Boolean));
        setChipList(passivesListEl, passivesArr);
        figuresInput.value = card.figures !== undefined && card.figures !== null && card.figures !== '' ? Number(card.figures) : (statsFallback?.figures != null ? statsFallback.figures : '');
        const a = card.attack || statsFallback?.attack;
        if (a) {
          const dice = Array.isArray(a.dice) ? a.dice : (a.dice ? [a.dice] : []);
          setChipList(attackDiceListEl, dice, DICE_LABELS);
          attackTypeSelect.value = (a.type === 'melee' || a.type === 'range') ? a.type : '';
        } else {
          setChipList(attackDiceListEl, []);
          attackTypeSelect.value = '';
        }
        const def = card.defense != null ? card.defense : statsFallback?.defense;
        const defenseArr = def == null ? [] : (Array.isArray(def) ? def : [def]);
        setChipList(defenseListEl, defenseArr, DEFENSE_LABELS);
        const surgeArr = card.surgeAbilities || statsFallback?.surgeAbilities || [];
        setChipList(surgeListEl, surgeArr, SURGE_LABELS);
        attachmentCheckbox.checked = !!(card.attachment);
        companionCheckbox.checked = !!(card.companion);
        companionNameInput.value = typeof card.companion === 'string' ? card.companion : '';
        const aff = card.affiliation || '';
        affiliationSelect.value = (aff === 'Mercenary' ? 'Scum' : aff === 'Neutral' ? 'Any' : aff) || '';
        eliteCheckbox.checked = card.elite === true || (card.elite !== false && /\(Elite\)\s*$/i.test(name));
      } else {
        abilityText.value = '';
        keywords.value = '';
        subnameInput.value = '';
        costInput.value = statsFallback?.cost != null ? statsFallback.cost : '';
        subCostInput.value = '';
        healthInput.value = statsFallback?.health != null ? statsFallback.health : '';
        speedInput.value = statsFallback?.speed != null ? statsFallback.speed : '';
        setChipList(passivesListEl, statsFallback?.passives ? (Array.isArray(statsFallback.passives) ? statsFallback.passives : [statsFallback.passives]) : []);
        figuresInput.value = statsFallback?.figures != null ? statsFallback.figures : '';
        const a = statsFallback?.attack;
        const dice = a && (Array.isArray(a.dice) ? a.dice : (a.dice ? [a.dice] : [])) || [];
        setChipList(attackDiceListEl, dice, DICE_LABELS);
        attackTypeSelect.value = (a && (a.type === 'melee' || a.type === 'range')) ? a.type : '';
        const def = statsFallback?.defense;
        setChipList(defenseListEl, def == null ? [] : (Array.isArray(def) ? def : [def]), DEFENSE_LABELS);
        setChipList(surgeListEl, statsFallback?.surgeAbilities || [], SURGE_LABELS);
        attachmentCheckbox.checked = false;
        companionCheckbox.checked = false;
        companionNameInput.value = '';
        eliteCheckbox.checked = /\(Elite\)\s*$/i.test((cardName.value || cardSelect.value || '').trim());
        affiliationSelect.value = '';
      }
    }

    cardSelect.addEventListener('change', () => {
      cardName.value = cardSelect.value || '';
      onCardChange();
    });
    cardName.addEventListener('input', () => {
      const v = cardName.value.trim();
      if (names.includes(v)) cardSelect.value = v;
      else cardSelect.value = '';
      onCardChange();
    });

    function getFigureStatsFromForm() {
      const speedVal = speedInput.value.trim();
      const speedNum = speedVal === '' ? undefined : (parseInt(speedVal, 10) || 0);
      const passivesArr = getChipValues(passivesListEl);
      const passives = passivesArr.length ? passivesArr : undefined;
      const figuresVal = figuresInput.value.trim();
      const figuresNum = figuresVal === '' ? undefined : (parseInt(figuresVal, 10) || 0);
      const attackDice = getChipValues(attackDiceListEl);
      const attackType = attackTypeSelect.value;
      const attack = attackDice.length
        ? { dice: attackDice, ...(attackType === 'range' || attackType === 'melee' ? { type: attackType } : {}) }
        : undefined;
      const defenseArr = getChipValues(defenseListEl);
      const defense = defenseArr.length ? defenseArr : undefined;
      const surgeAbilities = getChipValues(surgeListEl);
      return { speed: speedNum, passives, figures: figuresNum, attack, defense, surgeAbilities: surgeAbilities.length ? surgeAbilities : undefined };
    }

    addBtn.addEventListener('click', () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) { alert('Enter a card name'); return; }
      const kw = keywords.value.trim().split(/\s*,\s*/).filter(Boolean);
      const costVal = costInput.value.trim();
      const costNum = costVal === '' ? undefined : (parseInt(costVal, 10) || 0);
      const subCostVal = subCostInput.value.trim();
      const subCostNum = subCostVal === '' ? undefined : (parseInt(subCostVal, 10) || 0);
      const healthVal = healthInput.value.trim();
      const healthNum = healthVal === '' ? undefined : (parseInt(healthVal, 10) || 0);
      const existing = cards[name] || {};
      const fig = getFigureStatsFromForm();
      cards[name] = {
        abilityText: abilityText.value.trim() || '',
        keywords: kw,
        subname: subnameInput.value.trim() || undefined,
        cost: costNum,
        subCost: subCostNum,
        health: healthNum,
        speed: fig.speed,
        passives: fig.passives,
        figures: fig.figures,
        attack: fig.attack,
        defense: fig.defense,
        surgeAbilities: fig.surgeAbilities,
        attachment: attachmentCheckbox.checked,
        companion: companionCheckbox.checked ? (companionNameInput.value.trim() || true) : undefined,
        elite: eliteCheckbox.checked || undefined,
        affiliation: affiliationSelect.value || undefined,
        isIACPVariant: existing.isIACPVariant,
      };
      render();
      saveToFile(true);
    });

    document.getElementById('verifyBtn').addEventListener('click', () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) { alert('Select a card to verify'); return; }
      const kw = keywords.value.trim().split(/\s*,\s*/).filter(Boolean);
      const costVal = costInput.value.trim();
      const costNum = costVal === '' ? undefined : (parseInt(costVal, 10) || 0);
      const subCostVal = subCostInput.value.trim();
      const subCostNum = subCostVal === '' ? undefined : (parseInt(subCostVal, 10) || 0);
      const healthVal = healthInput.value.trim();
      const healthNum = healthVal === '' ? undefined : (parseInt(healthVal, 10) || 0);
      const existing = cards[name] || {};
      const fig = getFigureStatsFromForm();
      cards[name] = {
        abilityText: abilityText.value.trim() || '',
        keywords: kw,
        subname: subnameInput.value.trim() || undefined,
        cost: costNum,
        subCost: subCostNum,
        health: healthNum,
        speed: fig.speed,
        passives: fig.passives,
        figures: fig.figures,
        attack: fig.attack,
        defense: fig.defense,
        surgeAbilities: fig.surgeAbilities,
        attachment: attachmentCheckbox.checked,
        companion: companionCheckbox.checked ? (companionNameInput.value.trim() || true) : undefined,
        elite: eliteCheckbox.checked || undefined,
        affiliation: affiliationSelect.value || undefined,
        isIACPVariant: existing.isIACPVariant,
      };
      verified.add(name);
      saveVerified();
      saveToFile(true);
      render();
      const nextOpt = cardSelect.options[1];
      if (nextOpt && nextOpt.value) {
        cardSelect.value = nextOpt.value;
        cardName.value = nextOpt.value;
        onCardChange();
      } else {
        cardSelect.value = '';
        cardName.value = '';
        onCardChange();
      }
    });

    function renderDupPanel() {
      const panel = document.getElementById('dupPanel');
      const list = document.getElementById('dupList');
      const groups = getDuplicateGroups();
      if (groups.length === 0) {
        list.innerHTML = '<p class="hint">No suspected duplicates (no image path shared by multiple card names).</p>';
      } else {
        list.innerHTML = '';
        groups.forEach(([path, cardNames]) => {
          const g = document.createElement('div');
          g.className = 'dup-group';
          g.innerHTML = '<div class="path">' + path.replace(/</g, '&lt;') + '</div>';
          cardNames.forEach((c) => {
            const line = document.createElement('div');
            line.className = 'dup-card-line';
            const isIACP = !!(cards[c] && cards[c].isIACPVariant);
            line.innerHTML = '<span class="card-name"></span> ' + (isIACP ? '<span class="iacp-badge">IACP</span>' : '') + (isIACP ? '' : ' <button type="button" class="iacp mark-iacp-btn">Mark as IACP</button>');
            line.querySelector('.card-name').textContent = c;
            const markBtn = line.querySelector('.mark-iacp-btn');
            if (markBtn) markBtn.addEventListener('click', () => {
              cardNames.forEach((other) => {
                if (!cards[other]) cards[other] = {};
                cards[other].isIACPVariant = other === c;
              });
              saveToFile(true);
              renderDupPanel();
              updateMarkIacpVisibility();
            });
            line.querySelector('.card-name').addEventListener('click', () => {
              cardSelect.value = c;
              cardName.value = c;
              onCardChange();
            });
            line.querySelector('.card-name').style.cursor = 'pointer';
            g.appendChild(line);
          });
          list.appendChild(g);
        });
      }
    }

    function updateMarkIacpVisibility() {
      const name = (cardName.value || cardSelect.value || '').trim();
      const wrap = document.getElementById('markIacpWrap');
      const groups = getDuplicateGroups();
      const inDup = name && groups.some(([, arr]) => arr.includes(name));
      const alreadyMarked = name && !!(cards[name] && cards[name].isIACPVariant);
      wrap.style.display = inDup && !alreadyMarked ? 'inline-block' : 'none';
    }

    document.getElementById('showDupBtn').addEventListener('click', () => {
      const panel = document.getElementById('dupPanel');
      const show = panel.style.display === 'none';
      panel.style.display = show ? 'block' : 'none';
      if (show) renderDupPanel();
      document.getElementById('showDupBtn').textContent = show ? 'Hide duplicate cards' : 'Show duplicate cards';
    });

    document.getElementById('markIacpBtn').addEventListener('click', () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) return;
      const groups = getDuplicateGroups();
      const group = groups.find(([, arr]) => arr.includes(name));
      if (!group) return;
      const [, cardNames] = group;
      cardNames.forEach((c) => {
        if (!cards[c]) cards[c] = {};
        cards[c].isIACPVariant = c === name;
      });
      saveToFile(true);
      renderDupPanel();
      updateMarkIacpVisibility();
    });

    function render() {
      updateCardSelect();
      listEl.innerHTML = '';
      countEl.textContent = getUnverifiedCount();
      verifiedCountEl.textContent = getVerifiedCount();
      totalCountEl.textContent = names.length;
      updateMarkIacpVisibility();
      const unverified = getUnverifiedCards();
      unverified.forEach((name) => {
        const data = cards[name] || {};
        const kwStr = Array.isArray(data.keywords) ? data.keywords.join(', ') : (data.keywords || '');
        const div = document.createElement('div');
        div.className = 'entry';
        const costStr = data.cost !== undefined && data.cost !== null ? data.cost + ' pts' : '—';
        const subCostStr = data.subCost !== undefined && data.subCost !== null ? data.subCost + ' VP/fig' : '';
        const healthStr = data.health !== undefined && data.health !== null ? data.health + ' HP' : '';
        const attStr = data.attachment ? ' · Attachment' : '';
        const compStr = data.companion ? (' · Companion' + (typeof data.companion === 'string' ? ` (${data.companion})` : '')) : '';
        const eliteStr = data.elite ? ' · Elite' : '';
        const affStr = data.affiliation ? ' · ' + data.affiliation : '';
        const mid = [costStr, subCostStr, healthStr, kwStr || '—'].filter(Boolean).join(' · ');
        div.innerHTML = `<strong>${name}</strong> <span>${mid}${attStr}${compStr}${eliteStr}${affStr}</span> <button data-name="${name.replace(/"/g, '&quot;')}">Remove</button>`;
        div.querySelector('button').addEventListener('click', (e) => {
          e.stopPropagation();
          delete cards[name];
          render();
        });
        div.style.cursor = 'pointer';
        div.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') return;
          cardSelect.value = name;
          cardName.value = name;
          onCardChange();
        });
        listEl.appendChild(div);
      });
    }

    async function saveToFile(silent = false) {
      const out = { source: 'DC Effect Editor', cards };
      try {
        const r = await fetch('/api/save-dc-effects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(out),
        });
        const j = await r.json();
        if (j.ok && !silent) alert('Saved to data/dc-effects.json');
        else if (!j.ok) alert('Save failed: ' + (j.error || r.status));
      } catch (e) {
        alert('Save failed: ' + e.message + '. Run npm run cc-review first.');
      }
    }

    render();
    (async () => {
      try {
        const ri = await fetch('/data/dc-images.json');
        if (ri.ok) {
          const di = await ri.json();
          dcImages = di.dcImages || di || {};
        }
      } catch (_) {}
      try {
        const rc = await fetch('/data/companion-images.json');
        if (rc.ok) {
          const ci = await rc.json();
          const companionImages = ci.companionImages || ci || {};
          companionNames = new Set(Object.keys(companionImages));
          Object.assign(dcImages, companionImages);
        }
      } catch (_) {}
      names = Object.keys(dcImages).filter((k) => dcImages[k]).sort((a, b) => {
        const aCompanion = companionNames.has(a) ? 2 : 0;
        const bCompanion = companionNames.has(b) ? 2 : 0;
        if (aCompanion !== bCompanion) return aCompanion - bCompanion;
        const aSkirmish = a.startsWith('[') ? 1 : 0;
        const bSkirmish = b.startsWith('[') ? 1 : 0;
        if (aSkirmish !== bSkirmish) return aSkirmish - bSkirmish;
        return a.localeCompare(b);
      });
      try {
        const r = await fetch('/data/dc-effects.json');
        if (r.ok) {
          const d = await r.json();
          if (d.cards && Object.keys(d.cards).length > 0) cards = d.cards;
        }
      } catch (_) {}
      try {
        const rv = await fetch('/data/dc-verified.json');
        if (rv.ok) {
          const dv = await rv.json();
          if (dv.verified && Array.isArray(dv.verified)) {
            verified = new Set(dv.verified);
            localStorage.setItem(VERIFIED_KEY, JSON.stringify([...verified]));
          }
        }
      } catch (_) {}
      try {
        const rs = await fetch('/data/dc-stats.json');
        if (rs.ok) {
          const ds = await rs.json();
          dcStats = ds.dcStats || ds || {};
        }
      } catch (_) {}
      render();
      const firstOpt = cardSelect.options[1];
      if (firstOpt && firstOpt.value) {
        cardSelect.value = firstOpt.value;
        cardName.value = firstOpt.value;
        onCardChange();
      }
    })();
  </script>
</body>
</html>
