<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IA Skirmish — DC Effect Editor</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; padding: 20px; background: #1e1e1e; color: #eee; max-width: 960px; }
    h1 { font-size: 1.3rem; margin-bottom: 8px; }
    .hint { font-size: 12px; color: #999; margin-bottom: 16px; }
    .main { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    .card-img-wrap { flex-shrink: 0; width: 320px; min-height: 420px; background: #2d2d2d; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .card-img-wrap img { max-width: 100%; max-height: 460px; object-fit: contain; }
    .card-img-wrap .placeholder { color: #666; font-size: 13px; text-align: center; padding: 16px; }
    .form-wrap { flex: 1; min-width: 280px; }
    label { display: block; margin-top: 12px; margin-bottom: 4px; font-weight: 500; }
    select, input, textarea { width: 100%; padding: 8px 12px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 14px; }
    textarea { min-height: 80px; font-family: inherit; resize: vertical; }
    .row { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    button.primary { background: #0d6efd; color: #fff; }
    button.primary:hover { background: #0b5ed7; }
    button.export { background: #198754; color: #fff; }
    button.export:hover { background: #157347; }
    button.verified { background: #dc3545; color: #fff; }
    button.verified:hover { background: #bb2d3b; }
    .entries { margin-top: 24px; }
    .entries h2 { font-size: 1rem; margin-bottom: 8px; }
    .entry { padding: 8px 12px; margin-bottom: 6px; background: #2d2d2d; border-radius: 4px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
    .entry span { color: #aaa; }
    .entry button { padding: 4px 10px; font-size: 12px; background: #dc3545; }
    .entry button:hover { background: #bb2d3b; }
    .dup-panel { margin-top: 16px; padding: 12px; background: #2d2d2d; border-radius: 8px; border: 1px solid #555; }
    .dup-panel h3 { font-size: 0.95rem; margin: 0 0 8px 0; }
    .dup-group { margin-bottom: 12px; padding: 8px; background: #1e1e1e; border-radius: 4px; }
    .dup-group .path { font-size: 11px; color: #888; margin-bottom: 4px; word-break: break-all; }
    .dup-card-line { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .dup-card-line .iacp-badge { background: #198754; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
    button.iacp { background: #6f42c1; color: #fff; }
    button.iacp:hover { background: #5a32a3; }
  </style>
</head>
<body>
  <h1>IA Skirmish — Deployment Card Effect Editor</h1>
  <p class="hint">Run <code>npm run cc-review</code> and open <code>http://localhost:3456/scripts/dc-effect-editor.html</code>. Showing <strong>DC Skirmish Upgrades</strong> only (from dc-images). Correct ability text and keywords, then click <strong>VERIFIED</strong>. Progress = unverified count shrinking to 0.</p>

  <div class="main">
    <div class="card-img-wrap" id="cardImgWrap">
      <div class="placeholder" id="cardImgPlaceholder">Select a card</div>
      <img id="cardImg" alt="" style="display:none">
    </div>
    <div class="form-wrap">
  <label>Card name</label>
  <select id="cardSelect">
    <option value="">— Select or type below —</option>
  </select>
  <input type="text" id="cardName" placeholder="Or type DC name manually">

  <label>Ability text (passives, card text)</label>
  <p class="hint" style="margin: 2px 0 4px 0;">Full text of abilities, passives, and traits as printed. Use ALL CAPS for keywords (e.g. MASSIVE, MOBILE).</p>
  <textarea id="abilityText" placeholder="Paste or type card ability text"></textarea>

  <label>Keywords (comma-separated, e.g. Massive, Mobile)</label>
  <input type="text" id="keywords" placeholder="e.g. Massive, Mobile">

  <label>Cost (points)</label>
  <input type="number" id="cost" placeholder="e.g. 8" min="-10" max="40" step="1" style="width: 80px;">
  <p class="hint" style="margin: 2px 0 0 0;">Deployment cost (-10 to 40); meta deck has 40 points to spend.</p>

  <label style="display: flex; align-items: center; gap: 8px; margin-top: 12px;">
    <input type="checkbox" id="attachment" style="width: auto;">
    <span>Attachment</span>
  </label>
  <p class="hint" style="margin: 2px 0 0 0;">Check if this Skirmish upgrade is an attachment (e.g. weapon, armor).</p>

  <label>Affiliation</label>
  <select id="affiliation" style="width: auto; min-width: 140px;">
    <option value="">— Not set —</option>
    <option value="Imperial">Imperial</option>
    <option value="Rebel">Rebel</option>
    <option value="Scum">Scum</option>
    <option value="Any">Any</option>
  </select>
  <p class="hint" style="margin: 2px 0 0 0;">Deck draft is same affiliation only; use &quot;Any&quot; for cards that bypass this (e.g. Temporary Alliance).</p>

  <div id="statsWrap" class="hint" style="margin-top:12px; padding:8px; background:#2d2d2d; border-radius:4px; font-size:12px;"></div>

  <div class="row">
    <button id="addBtn" class="primary">Add / Update</button>
    <button id="verifyBtn" class="verified">VERIFIED</button>
    <button id="showDupBtn" class="iacp">Show duplicate cards</button>
    <span id="markIacpWrap" style="display:none;"><button id="markIacpBtn" class="iacp">Mark as IACP variant</button></span>
  </div>
    </div>
  </div>

  <div id="dupPanel" class="dup-panel" style="display: none; margin-top: 16px;">
    <h3>Suspected duplicates (same image path)</h3>
    <p class="hint">Use "Mark as IACP" to set which variant is the IACP one for priority. Saved in dc-effects.json.</p>
    <div id="dupList"></div>
  </div>

  <div class="entries">
    <h2>Unverified: <span id="count">0</span> — Verified: <span id="verifiedCount">0</span> — Total: <span id="totalCount">0</span> — Shrink unverified to 0 by clicking VERIFIED</h2>
    <div id="list"></div>
  </div>

  <script>
    const cardSelect = document.getElementById('cardSelect');
    const cardName = document.getElementById('cardName');
    const abilityText = document.getElementById('abilityText');
    const keywords = document.getElementById('keywords');
    const costInput = document.getElementById('cost');
    const attachmentCheckbox = document.getElementById('attachment');
    const affiliationSelect = document.getElementById('affiliation');
    const addBtn = document.getElementById('addBtn');
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const verifiedCountEl = document.getElementById('verifiedCount');
    const totalCountEl = document.getElementById('totalCount');

    const VERIFIED_KEY = 'dc-verified';
    let verified = new Set(JSON.parse(localStorage.getItem(VERIFIED_KEY) || '[]'));
    let names = [];
    let cards = {};
    let dcStats = {};
    let dcImages = {};

    function getDuplicateGroups() {
      const pathToCards = {};
      for (const [card, path] of Object.entries(dcImages)) {
        if (!path) continue;
        if (!pathToCards[path]) pathToCards[path] = [];
        pathToCards[path].push(card);
      }
      return Object.entries(pathToCards).filter(([, arr]) => arr.length > 1);
    }

    function saveVerified() {
      localStorage.setItem(VERIFIED_KEY, JSON.stringify([...verified]));
      saveVerifiedToFile(false);
    }

    async function saveVerifiedToFile(silent = false) {
      try {
        const r = await fetch('/api/save-dc-verified', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ verified: [...verified] }),
        });
        const text = await r.text();
        let j;
        try { j = JSON.parse(text); } catch { j = {}; }
        if (r.ok && j.ok) return;
        if (!silent) alert('Save verified failed: ' + (j.error || r.status + ' ' + text.slice(0, 80)));
      } catch (e) {
        if (!silent) alert('Save verified failed: ' + e.message + '. Restart npm run cc-review?');
      }
    }

    function getVerifiedCount() {
      return names.filter((n) => verified.has(n)).length;
    }
    function getUnverifiedCount() {
      return names.length - getVerifiedCount();
    }

    function getUnverifiedCards() {
      return names.filter((n) => !verified.has(n)).sort((a, b) => {
        const aNonFig = a.startsWith('[') ? 0 : 1;
        const bNonFig = b.startsWith('[') ? 0 : 1;
        if (aNonFig !== bNonFig) return aNonFig - bNonFig;
        return a.localeCompare(b);
      });
    }

    function updateCardSelect() {
      const unverified = getUnverifiedCards();
      cardSelect.innerHTML = '<option value="">— Select or type below —</option>';
      unverified.forEach((n) => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        cardSelect.appendChild(opt);
      });
    }

    function updateCardImage() {
      const name = (cardName.value || cardSelect.value || '').trim();
      const img = document.getElementById('cardImg');
      const placeholder = document.getElementById('cardImgPlaceholder');
      if (!name) {
        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.textContent = 'Select a card';
        return;
      }
      const apiUrl = '/api/dc-image/' + encodeURIComponent(name);
      img.src = apiUrl;
      img.alt = name;
      img.style.display = 'block';
      img.onload = () => { placeholder.style.display = 'none'; };
      img.onerror = () => {
        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.textContent = 'No image';
      };
      placeholder.style.display = 'none';
    }

    function updateStatsDisplay() {
      const name = (cardName.value || cardSelect.value || '').trim();
      const wrap = document.getElementById('statsWrap');
      if (!wrap) return;
      const stats = dcStats[name] || dcStats[name.replace(/\s*\[.*\]\s*$/, '')];
      if (!stats) {
        wrap.textContent = '';
        wrap.style.display = 'none';
        return;
      }
      wrap.style.display = 'block';
      const a = stats.attack;
      const attackStr = a ? (Array.isArray(a.dice) ? a.dice.join(', ') : a.dice) + ' range ' + (a.range ? a.range.join('–') : '—') : '—';
      wrap.innerHTML = 'Stats (from dc-stats): Cost ' + (stats.cost ?? '—') + ' · Health ' + (stats.health ?? '—') + ' · Figures ' + (stats.figures ?? '—') + ' · Speed ' + (stats.speed ?? '—') + ' · Attack ' + attackStr + ' · Defense ' + (stats.defense ?? '—') + (stats.specials && stats.specials.length ? ' · Specials: ' + stats.specials.join(', ') : '');
    }

    function onCardChange() {
      const name = (cardName.value || cardSelect.value || '').trim();
      updateCardImage();
      updateStatsDisplay();
      updateMarkIacpVisibility();
      if (name && cards[name]) {
        abilityText.value = cards[name].abilityText || '';
        keywords.value = Array.isArray(cards[name].keywords) ? cards[name].keywords.join(', ') : (cards[name].keywords || '');
        const c = cards[name].cost;
        const statsCost = name && (dcStats[name] || dcStats[name.replace(/\s*\[.*\]\s*$/, '')]);
        costInput.value = c !== undefined && c !== null && c !== '' ? Number(c) : (statsCost && (statsCost.cost !== undefined && statsCost.cost !== null) ? statsCost.cost : '');
        attachmentCheckbox.checked = !!(cards[name].attachment);
        const aff = cards[name].affiliation || '';
        affiliationSelect.value = (aff === 'Mercenary' ? 'Scum' : aff === 'Neutral' ? 'Any' : aff) || '';
      } else {
        abilityText.value = '';
        keywords.value = '';
        const statsCost = name && (dcStats[name] || dcStats[name.replace(/\s*\[.*\]\s*$/, '')]);
        costInput.value = statsCost && (statsCost.cost !== undefined && statsCost.cost !== null) ? statsCost.cost : '';
        attachmentCheckbox.checked = false;
        affiliationSelect.value = '';
      }
    }

    cardSelect.addEventListener('change', () => {
      cardName.value = cardSelect.value || '';
      onCardChange();
    });
    cardName.addEventListener('input', () => {
      const v = cardName.value.trim();
      if (names.includes(v)) cardSelect.value = v;
      else cardSelect.value = '';
      onCardChange();
    });

    addBtn.addEventListener('click', () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) { alert('Enter a card name'); return; }
      const kw = keywords.value.trim().split(/\s*,\s*/).filter(Boolean);
      const costVal = costInput.value.trim();
      const costNum = costVal === '' ? undefined : (parseInt(costVal, 10) || 0);
      const existing = cards[name] || {};
      cards[name] = {
        abilityText: abilityText.value.trim() || '',
        keywords: kw,
        cost: costNum,
        attachment: attachmentCheckbox.checked,
        affiliation: affiliationSelect.value || undefined,
        isIACPVariant: existing.isIACPVariant,
      };
      render();
      saveToFile(true);
    });

    document.getElementById('verifyBtn').addEventListener('click', () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) { alert('Select a card to verify'); return; }
      const kw = keywords.value.trim().split(/\s*,\s*/).filter(Boolean);
      const costVal = costInput.value.trim();
      const costNum = costVal === '' ? undefined : (parseInt(costVal, 10) || 0);
      const existing = cards[name] || {};
      cards[name] = {
        abilityText: abilityText.value.trim() || '',
        keywords: kw,
        cost: costNum,
        attachment: attachmentCheckbox.checked,
        affiliation: affiliationSelect.value || undefined,
        isIACPVariant: existing.isIACPVariant,
      };
      verified.add(name);
      saveVerified();
      saveToFile(true);
      render();
      const nextOpt = cardSelect.options[1];
      if (nextOpt && nextOpt.value) {
        cardSelect.value = nextOpt.value;
        cardName.value = nextOpt.value;
        onCardChange();
      } else {
        cardSelect.value = '';
        cardName.value = '';
        onCardChange();
      }
    });

    function renderDupPanel() {
      const panel = document.getElementById('dupPanel');
      const list = document.getElementById('dupList');
      const groups = getDuplicateGroups();
      if (groups.length === 0) {
        list.innerHTML = '<p class="hint">No suspected duplicates (no image path shared by multiple card names).</p>';
      } else {
        list.innerHTML = '';
        groups.forEach(([path, cardNames]) => {
          const g = document.createElement('div');
          g.className = 'dup-group';
          g.innerHTML = '<div class="path">' + path.replace(/</g, '&lt;') + '</div>';
          cardNames.forEach((c) => {
            const line = document.createElement('div');
            line.className = 'dup-card-line';
            const isIACP = !!(cards[c] && cards[c].isIACPVariant);
            line.innerHTML = '<span class="card-name"></span> ' + (isIACP ? '<span class="iacp-badge">IACP</span>' : '') + (isIACP ? '' : ' <button type="button" class="iacp mark-iacp-btn">Mark as IACP</button>');
            line.querySelector('.card-name').textContent = c;
            const markBtn = line.querySelector('.mark-iacp-btn');
            if (markBtn) markBtn.addEventListener('click', () => {
              cardNames.forEach((other) => {
                if (!cards[other]) cards[other] = {};
                cards[other].isIACPVariant = other === c;
              });
              saveToFile(true);
              renderDupPanel();
              updateMarkIacpVisibility();
            });
            line.querySelector('.card-name').addEventListener('click', () => {
              cardSelect.value = c;
              cardName.value = c;
              onCardChange();
            });
            line.querySelector('.card-name').style.cursor = 'pointer';
            g.appendChild(line);
          });
          list.appendChild(g);
        });
      }
    }

    function updateMarkIacpVisibility() {
      const name = (cardName.value || cardSelect.value || '').trim();
      const wrap = document.getElementById('markIacpWrap');
      const groups = getDuplicateGroups();
      const inDup = name && groups.some(([, arr]) => arr.includes(name));
      const alreadyMarked = name && !!(cards[name] && cards[name].isIACPVariant);
      wrap.style.display = inDup && !alreadyMarked ? 'inline-block' : 'none';
    }

    document.getElementById('showDupBtn').addEventListener('click', () => {
      const panel = document.getElementById('dupPanel');
      const show = panel.style.display === 'none';
      panel.style.display = show ? 'block' : 'none';
      if (show) renderDupPanel();
      document.getElementById('showDupBtn').textContent = show ? 'Hide duplicate cards' : 'Show duplicate cards';
    });

    document.getElementById('markIacpBtn').addEventListener('click', () => {
      const name = (cardName.value || cardSelect.value || '').trim();
      if (!name) return;
      const groups = getDuplicateGroups();
      const group = groups.find(([, arr]) => arr.includes(name));
      if (!group) return;
      const [, cardNames] = group;
      cardNames.forEach((c) => {
        if (!cards[c]) cards[c] = {};
        cards[c].isIACPVariant = c === name;
      });
      saveToFile(true);
      renderDupPanel();
      updateMarkIacpVisibility();
    });

    function render() {
      updateCardSelect();
      listEl.innerHTML = '';
      countEl.textContent = getUnverifiedCount();
      verifiedCountEl.textContent = getVerifiedCount();
      totalCountEl.textContent = names.length;
      updateMarkIacpVisibility();
      const unverified = getUnverifiedCards();
      unverified.forEach((name) => {
        const data = cards[name] || {};
        const kwStr = Array.isArray(data.keywords) ? data.keywords.join(', ') : (data.keywords || '');
        const div = document.createElement('div');
        div.className = 'entry';
        const costStr = data.cost !== undefined && data.cost !== null ? data.cost + ' pts' : '—';
        const attStr = data.attachment ? ' · Attachment' : '';
        const affStr = data.affiliation ? ' · ' + data.affiliation : '';
        div.innerHTML = `<strong>${name}</strong> <span>${costStr} · ${kwStr || '—'}${attStr}${affStr}</span> <button data-name="${name.replace(/"/g, '&quot;')}">Remove</button>`;
        div.querySelector('button').addEventListener('click', (e) => {
          e.stopPropagation();
          delete cards[name];
          render();
        });
        div.style.cursor = 'pointer';
        div.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') return;
          cardSelect.value = name;
          cardName.value = name;
          onCardChange();
        });
        listEl.appendChild(div);
      });
    }

    async function saveToFile(silent = false) {
      const out = { source: 'DC Effect Editor', cards };
      try {
        const r = await fetch('/api/save-dc-effects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(out),
        });
        const j = await r.json();
        if (j.ok && !silent) alert('Saved to data/dc-effects.json');
        else if (!j.ok) alert('Save failed: ' + (j.error || r.status));
      } catch (e) {
        alert('Save failed: ' + e.message + '. Run npm run cc-review first.');
      }
    }

    render();
    (async () => {
      try {
        const ri = await fetch('/data/dc-images.json');
        if (ri.ok) {
          const di = await ri.json();
          dcImages = di.dcImages || di || {};
          names = Object.keys(dcImages).filter((k) => dcImages[k] && dcImages[k].includes('DC Skirmish Upgrades')).sort((a, b) => a.localeCompare(b));
        }
      } catch (_) {}
      try {
        const r = await fetch('/data/dc-effects.json');
        if (r.ok) {
          const d = await r.json();
          if (d.cards && Object.keys(d.cards).length > 0) cards = d.cards;
        }
      } catch (_) {}
      try {
        const rv = await fetch('/data/dc-verified.json');
        if (rv.ok) {
          const dv = await rv.json();
          if (dv.verified && Array.isArray(dv.verified)) {
            verified = new Set(dv.verified);
            localStorage.setItem(VERIFIED_KEY, JSON.stringify([...verified]));
          }
        }
      } catch (_) {}
      try {
        const rs = await fetch('/data/dc-stats.json');
        if (rs.ok) {
          const ds = await rs.json();
          dcStats = ds.dcStats || ds || {};
        }
      } catch (_) {}
      render();
      const firstOpt = cardSelect.options[1];
      if (firstOpt && firstOpt.value) {
        cardSelect.value = firstOpt.value;
        cardName.value = firstOpt.value;
        onCardChange();
      }
    })();
  </script>
</body>
</html>
