/**
 * Extracts Command Card names from Vassal buildFile.xml.
 * Run: node scripts/extract-cc-names.js
 * Outputs: data/cc-names.json and scripts/cc-names.js (for static HTML editor)
 */

import { readFileSync, writeFileSync, mkdirSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = join(__dirname, '..');
const buildFile = join(rootDir, 'vassal_extracted', 'buildFile.xml');

const xml = readFileSync(buildFile, 'utf8');

// Extract Command Cards TabWidget section
const ccStart = xml.indexOf('entryName="Command Cards"');
if (ccStart === -1) throw new Error('Could not find Command Cards section');
const sectionStart = xml.lastIndexOf('<VASSAL.build.widget.TabWidget', ccStart);
const sectionEnd = xml.indexOf('</VASSAL.build.widget.TabWidget>', sectionStart) + '</VASSAL.build.widget.TabWidget>'.length;
const ccSection = xml.slice(sectionStart, sectionEnd);

// UI labels / dividers / traits from Vassal â€” not actual playable cards
const BLOCKLIST = new Set(['All CCs', 'Command Cards', '- Any Figure -', 'Brawler']);

// Match PieceSlot entryName where line contains "Command Card" (actual cards, not dividers)
const nameRe = /entryName="([^"]+)"[\s\S]*?Command Card/g;
const seen = new Set();
const names = [];
let m;
while ((m = nameRe.exec(ccSection)) !== null) {
  const name = m[1].trim();
  if (!name || seen.has(name)) continue;
  if (BLOCKLIST.has(name)) continue;
  if (/^--|^---$/.test(name)) continue;
  if (name.length < 2) continue;
  seen.add(name);
  names.push(name);
}

// Prefer display names that match image filenames (e.g. "Chaotic Force" not "Chaotic Force (Mercenary)")
const NAME_OVERRIDES = {
  'Chaotic Force (Mercenary)': 'Chaotic Force',
  'Combat Resupply (Imperial)': 'Combat Resupply',
  'Corrupting Force (Imperial)': 'Corrupting Force',
};
const overridden = names.map((n) => NAME_OVERRIDES[n] ?? n);
const namesFinal = [...new Set(overridden)].sort((a, b) => a.localeCompare(b));

const jsonOutput = {
  source: 'Vassal buildFile.xml',
  extractedAt: new Date().toISOString(),
  cards: namesFinal,
};


mkdirSync(join(rootDir, 'data'), { recursive: true });
mkdirSync(join(rootDir, 'scripts'), { recursive: true });

writeFileSync(join(rootDir, 'data', 'cc-names.json'), JSON.stringify(jsonOutput, null, 2), 'utf8');
writeFileSync(
  join(rootDir, 'scripts', 'cc-names.js'),
  `/** Auto-generated by extract-cc-names.js. Do not edit. */\nconst CC_NAMES = ${JSON.stringify(namesFinal)};\n`,
  'utf8'
);

console.log(`Extracted ${namesFinal.length} command card names to data/cc-names.json and scripts/cc-names.js`);
